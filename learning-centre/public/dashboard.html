<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SmartEdu æ•™å­¸å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .course-card {
        transition: all 0.3s ease;
      }
      .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      }
      .modal {
        transition: opacity 0.25s ease;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <header
      class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg"
    >
      <div
        class="container mx-auto px-4 py-4 flex justify-between items-center"
      >
        <div class="flex items-center space-x-3">
          <div class="bg-white bg-opacity-20 p-2 rounded-lg">
            <span class="text-2xl">ğŸ“š</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold">SmartEdu æ•™å­¸å¹³å°</h1>
            <p class="text-blue-100 text-sm">æ™ºæ…§å­¸ç¿’ï¼Œç„¡é™å¯èƒ½</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div
            id="userInfo"
            class="bg-white bg-opacity-20 px-4 py-2 rounded-lg"
          >
            <span class="font-medium">è¼‰å…¥ä¸­...</span>
          </div>
          <button
            id="logoutBtn"
            class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-medium transition-colors duration-200 shadow"
          >
            ç™»å‡ºç³»çµ±
          </button>
        </div>
      </div>
    </header>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <main class="container mx-auto px-4 py-8">
      <!-- æ­¡è¿è¨Šæ¯ -->
      <div class="text-center mb-12">
        <h2 id="welcome" class="text-3xl font-bold text-gray-800 mb-2">
          æ­¡è¿ä½¿ç”¨ SmartEdu
        </h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          é€™æ˜¯ä¸€å€‹æ•´åˆèª²ç¨‹ç®¡ç†ã€ç·šä¸Šå­¸ç¿’å’Œäº’å‹•äº¤æµçš„æ™ºæ…§æ•™è‚²å¹³å°
        </p>
      </div>

      <!-- å­¸ç”ŸåŠŸèƒ½æŒ‰éˆ• -->
      <div
        id="studentControls"
        class="hidden mb-8 flex justify-center space-x-4"
      >
        <button
          id="showMyCourses"
          class="btn-primary text-white px-6 py-3 rounded-lg font-medium shadow hover:shadow-lg transition-all duration-200"
        >
          ğŸ“š æˆ‘çš„èª²ç¨‹
        </button>
        <button
          id="showAllCourses"
          class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium shadow hover:bg-green-700 transition-all duration-200"
        >
          ğŸ” æ¢ç´¢èª²ç¨‹
        </button>
      </div>

      <!-- è€å¸«å°ˆç”¨æ§åˆ¶é¢æ¿ -->
      <section id="teacherControls" class="hidden mb-12">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-blue-100">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3"
              >ğŸ‘¨â€ğŸ«</span
            >
            å»ºç«‹æ–°èª²ç¨‹
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >èª²ç¨‹åç¨±</label
              >
              <input
                id="courseName"
                type="text"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="ä¾‹å¦‚ï¼šç¶²é é–‹ç™¼å…¥é–€"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >èª²ç¨‹æè¿°</label
              >
              <input
                id="courseDesc"
                type="text"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="ç°¡è¦æè¿°èª²ç¨‹å…§å®¹"
              />
            </div>
          </div>
          <button
            id="createCourse"
            class="btn-primary text-white px-6 py-3 rounded-lg font-medium shadow hover:shadow-lg transition-all duration-200"
          >
            å»ºç«‹èª²ç¨‹æˆ¿é–“
          </button>
        </div>
      </section>

      <!-- æˆ‘çš„èª²ç¨‹åˆ—è¡¨å€åŸŸ -->
      <section
        id="myCoursesSection"
        class="bg-white rounded-xl shadow-lg overflow-hidden"
      >
        <div
          class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200"
        >
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <span class="bg-blue-500 text-white p-2 rounded-lg mr-3">ğŸ“š</span>
            æˆ‘çš„èª²ç¨‹åˆ—è¡¨
          </h2>
        </div>
        <div class="p-6">
          <div id="myCourseList" class="space-y-4">
            <div class="text-center py-8">
              <div
                class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"
              ></div>
              <p class="text-gray-500">è¼‰å…¥èª²ç¨‹ä¸­...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- æ‰€æœ‰èª²ç¨‹åˆ—è¡¨å€åŸŸ -->
      <section
        id="allCoursesSection"
        class="bg-white rounded-xl shadow-lg overflow-hidden hidden"
      >
        <div
          class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200"
        >
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <span class="bg-green-500 text-white p-2 rounded-lg mr-3">ğŸ”</span>
            æ‰€æœ‰å¯ç”¨èª²ç¨‹
          </h2>
        </div>
        <div class="p-6">
          <div id="allCourseList" class="space-y-4">
            <div class="text-center py-8">
              <div
                class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"
              ></div>
              <p class="text-gray-500">è¼‰å…¥èª²ç¨‹ä¸­...</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- ç·¨è¼¯èª²ç¨‹æ¨¡æ…‹æ¡† -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ç·¨è¼¯èª²ç¨‹</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >èª²ç¨‹åç¨±</label
            >
            <input
              id="editCourseName"
              type="text"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >èª²ç¨‹æè¿°</label
            >
            <input
              id="editCourseDesc"
              type="text"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            />
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button
            id="cancelEdit"
            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition"
          >
            å–æ¶ˆ
          </button>
          <button
            id="saveEdit"
            class="btn-primary text-white px-5 py-2 rounded-lg font-medium"
          >
            å„²å­˜è®Šæ›´
          </button>
        </div>
      </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div
      id="deleteModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <div class="text-center">
          <div
            class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"
          >
            <span class="text-red-600 text-xl">âš ï¸</span>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤èª²ç¨‹</h3>
          <p class="text-gray-600 mb-6">
            æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹èª²ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œæ‰€æœ‰ç›¸é—œè³‡æ–™å°‡è¢«æ°¸ä¹…åˆªé™¤ã€‚
          </p>
        </div>
        <div class="flex justify-center space-x-3">
          <button
            id="cancelDelete"
            class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
          >
            å–æ¶ˆ
          </button>
          <button
            id="confirmDelete"
            class="bg-red-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-red-700 transition"
          >
            ç¢ºèªåˆªé™¤
          </button>
        </div>
      </div>
    </div>

    <!-- é å°¾ -->
    <footer class="bg-gray-800 text-white mt-12">
      <div class="container mx-auto px-4 py-6 text-center">
        <p>Â© 2024 SmartEdu æ•™å­¸å¹³å° - è®“å­¸ç¿’æ›´æ™ºæ…§</p>
      </div>
    </footer>

    <script>
      let currentEditingCourse = null;
      let currentDeletingCourse = null;
      let currentView = "myCourses";

      // ç™»å‡ºåŠŸèƒ½ï¼ˆç¢ºä¿åœ¨ init å‡½æ•¸å¤–é¢ï¼‰
      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          fetch("/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // æ¸…é™¤æ‰€æœ‰å„²å­˜ä¸¦é‡å®šå‘ï¼Œé˜²æ­¢è¿”å›
                sessionStorage.clear();
                localStorage.clear();
                // ä½¿ç”¨ replace é˜²æ­¢è¿”å›
                window.location.replace("/?" + "t=" + new Date().getTime());
              } else {
                alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
              }
            })
            .catch((error) => {
              console.error("ç™»å‡ºéŒ¯èª¤:", error);
              // å³ä½¿å‡ºéŒ¯ä¹Ÿé‡å®šå‘åˆ°ç™»å…¥é 
              window.location.replace("/?" + "t=" + new Date().getTime());
            });
        }
      }
      async function init() {
        try {
          // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ - æ·»åŠ ç·©å­˜æ§åˆ¶
          const res = await fetch("/check-auth", {
            method: "GET",
            headers: {
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
            credentials: "include",
          });

          if (!res.ok) {
            throw new Error("èªè­‰æª¢æŸ¥å¤±æ•—");
          }

          const data = await res.json();
          if (!data.success) {
            // å¦‚æœæœªç™»å…¥ï¼Œå¾¹åº•é‡å®šå‘
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace("/?" + "t=" + new Date().getTime());
            return;
          }

          const { role, username } = data.user;
          document.getElementById(
            "welcome"
          ).textContent = `ğŸ‘‹ æ­¡è¿ ${username} (${role})`;
          document.getElementById("userInfo").innerHTML = `
      <span class="font-medium">${username}</span>
      <span class="text-blue-100 text-sm block">${role}</span>
    `;

          // é¡¯ç¤ºè€å¸«æ§åˆ¶é¢æ¿
          if (role === "teacher") {
            document
              .getElementById("teacherControls")
              .classList.remove("hidden");
            loadTeacherCourses();
          } else {
            // é¡¯ç¤ºå­¸ç”ŸåŠŸèƒ½æŒ‰éˆ•
            document
              .getElementById("studentControls")
              .classList.remove("hidden");
            document
              .getElementById("myCoursesSection")
              .classList.remove("hidden");
            document
              .getElementById("allCoursesSection")
              .classList.add("hidden");
            loadMyCourses();
          }
        } catch (error) {
          console.error("èªè­‰æª¢æŸ¥éŒ¯èª¤:", error);
          // å‡ºéŒ¯æ™‚ä¹Ÿé‡å®šå‘åˆ°ç™»å…¥é 
          sessionStorage.clear();
          localStorage.clear();
          window.location.replace("/?" + "t=" + new Date().getTime());
          return;
        }

        // åœ¨ init å‡½æ•¸çš„æœ€å¾Œæ·»åŠ ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç¶å®š
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });
        // å»ºç«‹èª²ç¨‹åŠŸèƒ½
        document
          .getElementById("createCourse")
          ?.addEventListener("click", async () => {
            const name = document.getElementById("courseName").value.trim();
            const description = document
              .getElementById("courseDesc")
              .value.trim();
            if (!name) {
              alert("è«‹è¼¸å…¥èª²ç¨‹åç¨±ï¼");
              return;
            }

            const res = await fetch("/teacher/courses", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, description }),
            });
            const result = await res.json();
            if (result.success) {
              alert("âœ… èª²ç¨‹å·²æˆåŠŸå»ºç«‹ï¼");
              document.getElementById("courseName").value = "";
              document.getElementById("courseDesc").value = "";
              loadTeacherCourses();
            } else {
              alert("âŒ " + (result.message || "å»ºç«‹èª²ç¨‹å¤±æ•—"));
            }
          });

        // å­¸ç”ŸåŠŸèƒ½æŒ‰éˆ•
        document
          .getElementById("showMyCourses")
          ?.addEventListener("click", () => {
            showMyCourses();
          });

        document
          .getElementById("showAllCourses")
          ?.addEventListener("click", () => {
            showAllCourses();
          });

        // æ¨¡æ…‹æ¡†äº‹ä»¶è™•ç†
        setupModalEvents();

        // ä¿®å¾©ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç¶å®š
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });
      }

      function setupModalEvents() {
        // ç·¨è¼¯æ¨¡æ…‹æ¡†
        document.getElementById("cancelEdit").addEventListener("click", () => {
          document.getElementById("editModal").classList.add("hidden");
        });

        document
          .getElementById("saveEdit")
          .addEventListener("click", async () => {
            if (!currentEditingCourse) return;

            const name = document.getElementById("editCourseName").value.trim();
            const description = document
              .getElementById("editCourseDesc")
              .value.trim();

            if (!name) {
              alert("è«‹è¼¸å…¥èª²ç¨‹åç¨±");
              return;
            }

            try {
              const res = await fetch(
                `/teacher/courses/${currentEditingCourse.id}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ name, description }),
                }
              );

              const result = await res.json();
              if (result.success) {
                alert("âœ… èª²ç¨‹å·²æ›´æ–°ï¼");
                document.getElementById("editModal").classList.add("hidden");
                loadTeacherCourses();
              } else {
                alert("âŒ " + (result.message || "æ›´æ–°å¤±æ•—"));
              }
            } catch (error) {
              console.error("æ›´æ–°èª²ç¨‹éŒ¯èª¤:", error);
              alert("âŒ æ›´æ–°èª²ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤");
            }
          });

        // åˆªé™¤æ¨¡æ…‹æ¡†
        document
          .getElementById("cancelDelete")
          .addEventListener("click", () => {
            document.getElementById("deleteModal").classList.add("hidden");
          });

        document
          .getElementById("confirmDelete")
          .addEventListener("click", async () => {
            if (!currentDeletingCourse) return;

            try {
              const res = await fetch(
                `/teacher/courses/${currentDeletingCourse.id}`,
                {
                  method: "DELETE",
                }
              );

              const result = await res.json();
              if (result.success) {
                alert("âœ… èª²ç¨‹å·²åˆªé™¤ï¼");
                document.getElementById("deleteModal").classList.add("hidden");
                loadTeacherCourses();
              } else {
                alert("âŒ " + (result.message || "åˆªé™¤å¤±æ•—"));
              }
            } catch (error) {
              console.error("åˆªé™¤èª²ç¨‹éŒ¯èª¤:", error);
              alert("âŒ åˆªé™¤èª²ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤");
            }
          });
      }

      function showMyCourses() {
        currentView = "myCourses";
        document.getElementById("myCoursesSection").classList.remove("hidden");
        document.getElementById("allCoursesSection").classList.add("hidden");
        document.getElementById("showMyCourses").classList.add("btn-primary");
        document
          .getElementById("showMyCourses")
          .classList.remove("bg-gray-400");
        document
          .getElementById("showAllCourses")
          .classList.remove("bg-green-600");
        document.getElementById("showAllCourses").classList.add("bg-gray-400");
        loadMyCourses();
      }

      function showAllCourses() {
        currentView = "allCourses";
        document.getElementById("myCoursesSection").classList.add("hidden");
        document.getElementById("allCoursesSection").classList.remove("hidden");
        document
          .getElementById("showMyCourses")
          .classList.remove("btn-primary");
        document.getElementById("showMyCourses").classList.add("bg-gray-400");
        document.getElementById("showAllCourses").classList.add("bg-green-600");
        document
          .getElementById("showAllCourses")
          .classList.remove("bg-gray-400");
        loadAllCourses();
      }

      function openEditModal(course) {
        currentEditingCourse = course;
        document.getElementById("editCourseName").value = course.name;
        document.getElementById("editCourseDesc").value =
          course.description || "";
        document.getElementById("editModal").classList.remove("hidden");
      }

      function openDeleteModal(course) {
        currentDeletingCourse = course;
        document.getElementById("deleteModal").classList.remove("hidden");
      }

      async function loadTeacherCourses() {
        try {
          const res = await fetch("/teacher/courses");
          const data = await res.json();
          const list = document.getElementById("myCourseList");

          if (!data.length) {
            list.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4">ğŸ“</div>
              <p class="text-gray-500 mb-2">å°šæœªå»ºç«‹ä»»ä½•èª²ç¨‹</p>
              <p class="text-gray-400 text-sm">ä½¿ç”¨ä¸Šæ–¹çš„è¡¨å–®å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹èª²ç¨‹</p>
            </div>
          `;
            return;
          }

          list.innerHTML = data
            .map(
              (course) => `
          <div class="course-card bg-white border border-gray-200 rounded-lg p-5 hover:border-blue-300">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
              <div class="mb-3 md:mb-0 flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${
                  course.name
                }</h3>
                <p class="text-gray-600 text-sm mb-2">${
                  course.description || "æš«ç„¡æè¿°"
                }</p>
                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-2">
                  <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded">èª²ç¨‹ ID: ${
                    course.id
                  }</span>
                  <span class="bg-green-100 text-green-600 px-2 py-1 rounded">æˆ¿é–“ ID: ${
                    course.room_id || "N/A"
                  }</span>
                  <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded">å­¸ç”Ÿäººæ•¸: ${
                    course.student_count || 0
                  }</span>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 md:mt-0">
                ${
                  course.room_id
                    ? `
                  <a href="/teacher-room/${course.id}"
                     class="btn-primary text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow hover:shadow-lg text-center">
                    é€²å…¥æ•™å®¤
                  </a>
                `
                    : ""
                }
                <button onclick="openEditModal(${JSON.stringify(course).replace(
                  /"/g,
                  "&quot;"
                )})" 
                        class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600 transition-colors text-center">
                  ç·¨è¼¯
                </button>
                <button onclick="openDeleteModal(${JSON.stringify(
                  course
                ).replace(/"/g, "&quot;")})" 
                        class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors text-center">
                  åˆªé™¤
                </button>
              </div>
            </div>
          </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("è¼‰å…¥èª²ç¨‹å¤±æ•—:", error);
          document.getElementById("myCourseList").innerHTML = `
          <div class="text-center py-8 text-red-500">
            <p>è¼‰å…¥èª²ç¨‹å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
          </div>
        `;
        }
      }

      async function loadMyCourses() {
        try {
          const res = await fetch("/student/courses");
          const data = await res.json();
          const list = document.getElementById("myCourseList");

          if (!data.length) {
            list.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4">ğŸ“</div>
              <p class="text-gray-500 mb-2">å°šæœªåŠ å…¥ä»»ä½•èª²ç¨‹</p>
              <p class="text-gray-400 text-sm">é»æ“Š"æ¢ç´¢èª²ç¨‹"ä¾†å°‹æ‰¾ä¸¦åŠ å…¥æ„Ÿèˆˆè¶£çš„èª²ç¨‹</p>
            </div>
          `;
            return;
          }

          list.innerHTML = data
            .map(
              (course) => `
          <div class="course-card bg-white border border-gray-200 rounded-lg p-5 hover:border-blue-300">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
              <div class="mb-3 md:mb-0 flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${
                  course.name
                }</h3>
                <p class="text-gray-600 text-sm mb-2">${
                  course.description || "æš«ç„¡æè¿°"
                }</p>
                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-2">
                  <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded">èª²ç¨‹ ID: ${
                    course.id
                  }</span>
                  <span class="bg-green-100 text-green-600 px-2 py-1 rounded">æˆ¿é–“ ID: ${
                    course.room_id || "N/A"
                  }</span>
                  <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded">æ•™å¸«: ${
                    course.teacher_name
                  }</span>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 md:mt-0">
                ${
                  course.room_id
                    ? `
                 <a href="/student-room/${course.id}"
                     class="btn-primary text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow hover:shadow-lg text-center">
                    é€²å…¥æ•™å®¤
                  </a>
                `
                    : ""
                }
                <button onclick="unenrollCourse(${course.id})" 
                        class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors text-center">
                  é€€é¸
                </button>
              </div>
            </div>
          </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("è¼‰å…¥æˆ‘çš„èª²ç¨‹å¤±æ•—:", error);
          document.getElementById("myCourseList").innerHTML = `
          <div class="text-center py-8 text-red-500">
            <p>è¼‰å…¥èª²ç¨‹å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
          </div>
        `;
        }
      }

      async function loadAllCourses() {
        try {
          const res = await fetch("/courses");
          const data = await res.json();
          const list = document.getElementById("allCourseList");

          if (!data.length) {
            list.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4">ğŸ“š</div>
              <p class="text-gray-500 mb-2">æš«ç„¡å¯ç”¨èª²ç¨‹</p>
              <p class="text-gray-400 text-sm">è«‹è¯ç¹«è€å¸«å»ºç«‹èª²ç¨‹</p>
            </div>
          `;
            return;
          }

          list.innerHTML = data
            .map(
              (course) => `
          <div class="course-card bg-white border border-gray-200 rounded-lg p-5 hover:border-green-300">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
              <div class="mb-3 md:mb-0 flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${
                  course.name
                }</h3>
                <p class="text-gray-600 text-sm mb-2">${
                  course.description || "æš«ç„¡æè¿°"
                }</p>
                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-2">
                  <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded">èª²ç¨‹ ID: ${
                    course.id
                  }</span>
                  <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded">æ•™å¸«: ${
                    course.teacher_name
                  }</span>
                  <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">å»ºç«‹æ™‚é–“: ${new Date(
                    course.created_at
                  ).toLocaleDateString()}</span>
                </div>
              </div>
              <div class="mt-3 md:mt-0">
                ${
                  course.is_enrolled
                    ? `
                  <div class="flex items-center space-x-2">
                    <span class="bg-green-100 text-green-600 px-3 py-2 rounded-lg font-medium">å·²é¸èª²</span>
                    <button onclick="unenrollCourse(${course.id})" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors">
                      é€€é¸
                    </button>
                  </div>
                `
                    : `
                  <button onclick="enrollCourse(${course.id})" 
                          class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    é¸èª²
                  </button>
                `
                }
              </div>
            </div>
          </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("è¼‰å…¥æ‰€æœ‰èª²ç¨‹å¤±æ•—:", error);
          document.getElementById("allCourseList").innerHTML = `
          <div class="text-center py-8 text-red-500">
            <p>è¼‰å…¥èª²ç¨‹å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
          </div>
        `;
        }
      }

      async function enrollCourse(courseId) {
        try {
          const res = await fetch("/student/enroll", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ course_id: courseId }),
          });
          const result = await res.json();

          if (result.success) {
            alert("âœ… " + result.message);
            // åˆ·æ–°ç•¶å‰è¦–åœ–
            if (currentView === "myCourses") {
              loadMyCourses();
            } else {
              loadAllCourses();
            }
          } else {
            alert("âŒ " + result.message);
          }
        } catch (error) {
          console.error("é¸èª²éŒ¯èª¤:", error);
          alert("âŒ é¸èª²æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
      }

      async function unenrollCourse(courseId) {
        if (!confirm("ç¢ºå®šè¦é€€é¸é€™å€‹èª²ç¨‹å—ï¼Ÿ")) {
          return;
        }

        try {
          const res = await fetch("/student/unenroll", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ course_id: courseId }),
          });
          const result = await res.json();

          if (result.success) {
            alert("âœ… " + result.message);
            // åˆ·æ–°ç•¶å‰è¦–åœ–
            if (currentView === "myCourses") {
              loadMyCourses();
            } else {
              loadAllCourses();
            }
          } else {
            alert("âŒ " + result.message);
          }
        } catch (error) {
          console.error("é€€é¸éŒ¯èª¤:", error);
          alert("âŒ é€€é¸æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
      }

      // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      window.addEventListener("load", function () {
        // é˜²æ­¢ç·©å­˜ï¼Œç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        fetch("/check-auth", {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache, no-store, must-revalidate",
            Pragma: "no-cache",
            Expires: "0",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              // æœªç™»å…¥ï¼Œç«‹å³é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦é˜»æ­¢é é¢é¡¯ç¤º
              document.body.innerHTML = `
              <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
                <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                  <h1 style="color: #ef4444; margin-bottom: 1rem;">âš ï¸ æœªæˆæ¬Šè¨ªå•</h1>
                  <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">${JSON.stringify(
                    data,
                    null,
                    2
                  )}</pre>
                  <p style="margin-top: 1rem; color: #6b7280;">
                    <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                  </p>
                </div>
              </div>
            `;
              return;
            }
            // å¦‚æœç™»å…¥ç‹€æ…‹æœ‰æ•ˆï¼Œåˆå§‹åŒ–é é¢
            init();
          })
          .catch((error) => {
            console.error("èªè­‰æª¢æŸ¥éŒ¯èª¤:", error);
            document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
              <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                <h1 style="color: #ef4444; margin-bottom: 1rem;">âŒ é€£æ¥éŒ¯èª¤</h1>
                <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">{"success": false, "message": "è«‹å…ˆç™»å…¥ç³»çµ±"}</pre>
                <p style="margin-top: 1rem; color: #6b7280;">
                  <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                </p>
              </div>
            </div>
          `;
          });
      });

      // é˜²æ­¢ä½¿ç”¨ç€è¦½å™¨è¿”å›æŒ‰éˆ•
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          // é é¢æ˜¯å¾ç·©å­˜è¼‰å…¥çš„ï¼Œé‡æ–°æª¢æŸ¥ç™»å…¥ç‹€æ…‹
          window.location.reload();
        }
      });
    </script>
  </body>
</html>
