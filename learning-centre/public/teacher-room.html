<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>æ•™å¸«å°ˆå€ - èª²ç¨‹æˆ¿é–“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .section {
        display: none;
      }
      .section.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .progress-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #e5e7eb;
      }
      .progress-fill {
        height: 100%;
        transition: width 0.5s ease;
      }
      .message-container {
        max-height: 400px;
        overflow-y: auto;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.info {
        background-color: #3b82f6;
      }
      .material-card {
        transition: all 0.3s ease;
      }
      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div id="notificationArea"></div>

    <!-- Navbar -->
    <header
      class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 flex justify-between items-center shadow-lg"
    >
      <div class="flex items-center space-x-4">
        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
          <span class="text-xl">ğŸ‘¨â€ğŸ«</span>
        </div>
        <div>
          <h1 class="text-xl font-bold" id="courseTitle">SmartEdu æ•™å¸«å°ˆå€</h1>
          <p class="text-sm text-blue-200" id="roomInfo"></p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <span id="userDisplay">ğŸ‘¨ğŸ»â€ğŸ« è¼‰å…¥ä¸­...</span>
        <button
          onclick="logout()"
          class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition-colors"
        >
          ç™»å‡º
        </button>
        <button
          onclick="goBack()"
          class="bg-gray-500 px-4 py-2 rounded hover:bg-gray-600 transition-colors"
        >
          è¿”å›èª²ç¨‹åˆ—è¡¨
        </button>
      </div>
    </header>

    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white shadow-lg p-4">
        <div
          class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100"
        >
          <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
            <i class="fas fa-chart-bar mr-2"></i>èª²ç¨‹çµ±è¨ˆ
          </h3>
          <div class="mt-2 space-y-3 text-sm">
            <div class="flex justify-between">
              <span>å­¸ç”Ÿäººæ•¸:</span>
              <span id="studentCount" class="font-semibold text-blue-700"
                >0</span
              >
            </div>
            <div class="flex justify-between">
              <span>æ•™ææ•¸é‡:</span>
              <span id="materialCount" class="font-semibold text-green-700"
                >0</span
              >
            </div>
            <div class="flex justify-between">
              <span>ä½œæ¥­æ•¸é‡:</span>
              <span id="homeworkCount" class="font-semibold text-purple-700"
                >0</span
              >
            </div>
            <div class="flex justify-between">
              <span>èª²å ‚éŒ„å½±:</span>
              <span class="font-semibold text-yellow-700">0</span>
            </div>
          </div>
        </div>

        <nav class="space-y-2">
          <button
            onclick="showSection('materials', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 bg-blue-50 text-blue-700 font-medium transition-colors flex items-center"
          >
            <i class="fas fa-folder mr-3"></i>æ•™æç®¡ç†
          </button>
          <button
            onclick="showSection('live', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-video mr-3"></i>ç›´æ’­èª²å ‚
          </button>
          <button
            onclick="showSection('homework', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-tasks mr-3"></i>ä½œæ¥­èˆ‡æ¸¬é©—
          </button>
          <button
            onclick="showSection('review', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-film mr-3"></i>èª²å ‚é‡æº«ç®¡ç†
          </button>
          <button
            onclick="showSection('documents', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-file-edit mr-3"></i>æ–‡ä»¶æ‰¹æ”¹
          </button>
          <button
            onclick="showSection('students', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-user-graduate mr-3"></i>å­¸ç”Ÿç®¡ç†
          </button>
          <button
            onclick="showSection('chat', this)"
            class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-100 transition-colors flex items-center"
          >
            <i class="fas fa-comments mr-3"></i>äº’å‹•èŠå¤©å®¤
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6 overflow-y-auto">
        <!-- 1) æ•™æç®¡ç† -->
        <div id="materials" class="section active">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-folder-open mr-3 text-blue-500"></i>æ•™æç®¡ç†
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-upload mr-2"></i>ä¸Šè¼‰æ–°æ•™æ
                </h3>
                <div class="space-y-4">
                  <input
                    type="file"
                    id="materialFile"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                  <input
                    type="text"
                    id="materialTitle"
                    placeholder="æ•™ææ¨™é¡Œ"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                  <select
                    id="materialType"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  >
                    <option value="">é¸æ“‡é¡å‹</option>
                    <option value="è¬›ç¾©">è¬›ç¾©</option>
                    <option value="ç·´ç¿’é¡Œ">ç·´ç¿’é¡Œ</option>
                    <option value="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</option>
                    <option value="è¦–é »">è¦–é »</option>
                  </select>
                  <button
                    onclick="uploadMaterial()"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                  >
                    <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šè¼‰æ•™æ
                  </button>
                </div>
              </div>
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-list mr-2"></i>å·²ä¸Šè¼‰æ•™æ
                </h3>
                <div
                  id="materialsList"
                  class="space-y-3 max-h-64 overflow-y-auto"
                >
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-4">
                      <i class="fas fa-folder-open"></i>
                    </div>
                    <p>æš«ç„¡æ•™æ</p>
                    <p class="text-sm mt-1">ä½¿ç”¨å·¦å´è¡¨å–®ä¸Šå‚³æ•™æ</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2) ç›´æ’­èª²å ‚ -->
        <div id="live" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-video mr-3 text-blue-500"></i>ç›´æ’­èª²å ‚
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-cogs mr-2"></i>ç›´æ’­è¨­å®š
                </h3>
                <div class="space-y-4">
                  <div>
                    <label class="block mb-2 text-gray-700">èª²å ‚æ¨™é¡Œï¼š</label>
                    <input
                      id="liveTitle"
                      type="text"
                      class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                      placeholder="è¼¸å…¥èª²å ‚æ¨™é¡Œ"
                    />
                  </div>

                  <div>
                    <label class="block mb-2 text-gray-700"
                      >è¨­å®šèª²å ‚æ—¥æœŸæ™‚é–“ï¼š</label
                    >
                    <input
                      id="liveDateTime"
                      type="datetime-local"
                      class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    />
                  </div>

                  <div>
                    <label class="block mb-2 text-gray-700"
                      >èª²å ‚æ™‚é•·ï¼ˆåˆ†é˜ï¼‰ï¼š</label
                    >
                    <input
                      id="liveDuration"
                      type="number"
                      min="15"
                      max="480"
                      value="60"
                      class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                      placeholder="èª²å ‚æ™‚é•·"
                    />
                  </div>

                  <div>
                    <label class="block mb-2 text-gray-700">èª²å ‚æè¿°ï¼š</label>
                    <textarea
                      id="liveDescription"
                      class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                      rows="3"
                      placeholder="èª²å ‚å…§å®¹æè¿°"
                    ></textarea>
                  </div>

                  <button
                    id="startLiveBtn"
                    onclick="createZoomMeeting()"
                    class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center"
                  >
                    <i class="fas fa-video mr-2"></i>å‰µå»º Zoom æœƒè­°
                  </button>

                  <div
                    id="meetingInfo"
                    class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
                  >
                    <h4 class="font-semibold text-blue-800 mb-2">æœƒè­°è³‡è¨Š</h4>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span>æœƒè­° ID:</span>
                        <span id="meetingId" class="font-mono"></span>
                      </div>
                      <div class="flex justify-between">
                        <span>å¯†ç¢¼:</span>
                        <span id="meetingPassword" class="font-mono"></span>
                      </div>
                      <div class="mt-3">
                        <button
                          id="joinMeetingBtn"
                          class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                        >
                          <i class="fas fa-external-link-alt mr-2"></i>åŠ å…¥æœƒè­°
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-eye mr-2"></i>ç›´æ’­é è¦½
                </h3>
                <div
                  class="bg-gray-800 h-64 flex items-center justify-center rounded-xl mb-4"
                >
                  <div class="text-center text-white">
                    <div class="text-5xl mb-2">
                      <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <p class="text-xl font-medium">ç›´æ’­é è¦½</p>
                    <p class="text-blue-200 mt-2">æº–å‚™é–‹å§‹ç›´æ’­</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                  >
                    <i class="fas fa-share-alt mr-2"></i>åˆ†äº«éˆæ¥
                  </button>
                  <button
                    class="bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center"
                  >
                    <i class="fas fa-record-vinyl mr-2"></i>éŒ„è£½èª²ç¨‹
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3) ä½œæ¥­èˆ‡æ¸¬é©— -->
        <div id="homework" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-tasks mr-3 text-blue-500"></i>ä½œæ¥­èˆ‡æ¸¬é©—
          </h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦ï¼šä½œæ¥­ç®¡ç† -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                <i class="fas fa-file-upload mr-2"></i>ä½œæ¥­ç®¡ç†
              </h3>
              <div class="space-y-4">
                <input
                  type="text"
                  id="homeworkTitle"
                  placeholder="ä½œæ¥­æ¨™é¡Œ"
                  class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                />
                <textarea
                  id="homeworkDescription"
                  placeholder="ä½œæ¥­æè¿°"
                  class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  rows="3"
                ></textarea>
                <input
                  type="datetime-local"
                  id="homeworkDeadline"
                  class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  placeholder="æˆªæ­¢æ—¥æœŸ"
                />
                <button
                  onclick="createHomework()"
                  class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                >
                  <i class="fas fa-paper-plane mr-2"></i>ç™¼ä½ˆä½œæ¥­
                </button>
              </div>

              <div class="mt-6">
                <h4 class="font-medium mb-3 text-blue-700">å·²ç™¼ä½ˆä½œæ¥­</h4>
                <div id="homeworkList" class="space-y-3">
                  <div class="text-center py-4 text-gray-500">
                    <p>æš«ç„¡ä½œæ¥­</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- å³ï¼šæˆç¸¾ç®¡ç† -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                <i class="fas fa-chart-line mr-2"></i>ä½œæ¥­æäº¤èˆ‡æ‰¹æ”¹
              </h3>
              <div id="submissionList" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                  <div class="text-4xl mb-4">
                    <i class="fas fa-file-alt"></i>
                  </div>
                  <p>æš«ç„¡ä½œæ¥­æäº¤</p>
                  <p class="text-sm mt-1">é¸æ“‡å·¦å´ä½œæ¥­æŸ¥çœ‹æäº¤æƒ…æ³</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 4) èª²å ‚é‡æº«ç®¡ç† -->
        <div id="review" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-film mr-3 text-blue-500"></i>èª²å ‚é‡æº«ç®¡ç†
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-upload mr-2"></i>ä¸Šè¼‰èª²å ‚éŒ„å½±
                </h3>
                <div class="space-y-4">
                  <input
                    type="file"
                    accept="video/*"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                  <input
                    type="text"
                    placeholder="éŒ„å½±æ¨™é¡Œ"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                  <textarea
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    rows="3"
                    placeholder="éŒ„å½±æè¿°"
                  ></textarea>
                  <button
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                  >
                    <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šè¼‰éŒ„å½±
                  </button>
                </div>
              </div>
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-list mr-2"></i>å·²ä¸Šè¼‰èª²å ‚
                </h3>
                <div class="space-y-4">
                  <div
                    class="flex justify-between items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors"
                  >
                    <div>
                      <span class="font-medium">æ•¸å­¸ - å‡½æ•¸èª²</span>
                      <p class="text-sm text-gray-500">
                        2024-01-10 â€¢ 2å°æ™‚15åˆ†é˜
                      </p>
                    </div>
                    <div class="space-x-2">
                      <button
                        class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div
                    class="flex justify-between items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors"
                  >
                    <div>
                      <span class="font-medium">è‹±æ–‡ - æ–‡æ³•èª²</span>
                      <p class="text-sm text-gray-500">
                        2024-01-12 â€¢ 1å°æ™‚45åˆ†é˜
                      </p>
                    </div>
                    <div class="space-x-2">
                      <button
                        class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 5) æ–‡ä»¶æ‰¹æ”¹ -->
        <div id="documents" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-file-edit mr-3 text-blue-500"></i>æ–‡ä»¶æ‰¹æ”¹
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-file-alt mr-2"></i>å­¸ç”Ÿä½œæ¥­
                </h3>
                <div
                  id="documentsList"
                  class="space-y-3 max-h-64 overflow-y-auto"
                >
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-4">
                      <i class="fas fa-file-alt"></i>
                    </div>
                    <p>æš«ç„¡ä½œæ¥­</p>
                    <p class="text-sm mt-1">
                      åœ¨ä½œæ¥­èˆ‡æ¸¬é©—ä¸­ç™¼ä½ˆä½œæ¥­å¾Œï¼Œå­¸ç”Ÿæäº¤çš„ä½œæ¥­å°‡é¡¯ç¤ºåœ¨é€™è£¡
                    </p>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="font-semibold mb-4 text-blue-800 flex items-center">
                  <i class="fas fa-edit mr-2"></i>æ‰¹æ”¹å·¥å…·
                </h3>
                <div
                  class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200"
                >
                  <p class="text-sm text-gray-600 mb-3">
                    é¸æ“‡å·¦å´çš„ä½œæ¥­é–‹å§‹æ‰¹æ”¹
                  </p>
                  <textarea
                    id="gradingFeedback"
                    class="w-full border rounded-lg p-3 mb-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    rows="6"
                    placeholder="æ‰¹æ”¹æ„è¦‹..."
                  ></textarea>
                  <div class="flex items-center mb-3">
                    <label class="mr-3 text-gray-700">è©•åˆ†:</label>
                    <input
                      type="number"
                      id="gradingScore"
                      min="0"
                      max="100"
                      class="w-20 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    />
                    <span class="ml-2 text-gray-600">/100</span>
                  </div>
                  <div class="flex space-x-3">
                    <button
                      onclick="saveGrading()"
                      class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                    >
                      <i class="fas fa-save mr-2"></i>å„²å­˜æ‰¹æ”¹
                    </button>
                    <button
                      onclick="submitGrading()"
                      class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center"
                    >
                      <i class="fas fa-paper-plane mr-2"></i>ç™¼é€å›é¥‹
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 6) å­¸ç”Ÿç®¡ç† -->
        <div id="students" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-user-graduate mr-3 text-blue-500"></i>å­¸ç”Ÿç®¡ç†
          </h2>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="overflow-x-auto">
              <table class="w-full border rounded-lg overflow-hidden">
                <thead class="bg-gradient-to-r from-blue-50 to-indigo-50">
                  <tr>
                    <th class="border px-4 py-3 text-left text-blue-700">
                      å­¸ç”Ÿå§“å
                    </th>
                    <th class="border px-4 py-3 text-center text-blue-700">
                      é¸èª²æ™‚é–“
                    </th>
                    <th class="border px-4 py-3 text-center text-blue-700">
                      å·²é¸èª²ç¨‹
                    </th>
                    <th class="border px-4 py-3 text-center text-blue-700">
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <tr>
                    <td
                      colspan="4"
                      class="border px-4 py-6 text-center text-gray-500"
                    >
                      <div class="text-4xl mb-2">
                        <i class="fas fa-user-graduate"></i>
                      </div>
                      <p>è¼‰å…¥å­¸ç”Ÿè³‡æ–™ä¸­...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 7) äº’å‹•èŠå¤©å®¤ -->
        <div id="chat" class="section">
          <h2 class="text-2xl font-bold mb-6 text-blue-900 flex items-center">
            <i class="fas fa-comments mr-3 text-blue-500"></i>äº’å‹•èŠå¤©å®¤
          </h2>
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div
              class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50"
            >
              <h3 class="font-semibold text-blue-800">æ•™å¸«èŠå¤©å®¤</h3>
              <p class="text-sm text-gray-600">èˆ‡å­¸ç”Ÿäº¤æµå­¸ç¿’å•é¡Œ</p>
            </div>

            <div
              class="p-4 h-96 overflow-y-auto border-b message-container"
              id="teacherChatMessages"
            >
              <div class="text-center text-gray-500 py-8">
                <div class="text-4xl mb-2">ğŸ’¬</div>
                <p>èª²å®¤èŠå¤©å®¤</p>
                <p class="text-sm mt-1">é–‹å§‹èˆ‡å­¸ç”Ÿå°è©±</p>
              </div>
            </div>

            <div class="p-4">
              <div class="flex space-x-2">
                <input
                  type="text"
                  id="teacherMessageInput"
                  placeholder="è¼¸å…¥è¨Šæ¯..."
                  class="flex-1 border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                />
                <button
                  onclick="sendTeacherMessage()"
                  class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
                >
                  <i class="fas fa-paper-plane mr-2"></i>ç™¼é€
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // å…¨å±€è®Šé‡
      let currentRoomData = null;
      let currentUser = null;
      let currentCourseId = null;
      let currentSelectedSubmission = null;

      // åˆå§‹åŒ–é é¢

      async function init() {
        // å¾URLç²å–èª²ç¨‹ID
        const pathSegments = window.location.pathname.split("/");
        currentCourseId = pathSegments[pathSegments.length - 1];

        if (!currentCourseId || isNaN(currentCourseId)) {
          showNotification("ç„¡æ•ˆçš„èª²ç¨‹ID", "error");
          return;
        }

        try {
          // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ - åªä¿®æ”¹é€™éƒ¨åˆ†
          const authResponse = await fetch("/check-auth", {
            method: "GET",
            headers: {
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
            credentials: "include",
          });

          if (!authResponse.ok) {
            throw new Error("ç”¨æˆ¶æœªç™»å…¥");
          }

          const authData = await authResponse.json();

          if (!authData.success) {
            // å¦‚æœæœªç™»å…¥ï¼Œå¾¹åº•é‡å®šå‘
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace("/?" + "t=" + new Date().getTime());
            return;
          }

          currentUser = authData.user;
          document.getElementById("userDisplay").textContent =
            "ğŸ‘¨ğŸ»â€ğŸ« " + currentUser.username;

          // === åŸæœ‰çš„åˆå§‹åŒ–ä»£ç¢¼ç¹¼çºŒ ===
          // å¾æœå‹™ç«¯ç²å–æˆ¿é–“æ•¸æ“š
          const response = await fetch(`/room/${currentCourseId}`, {
            method: "GET",
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("ç²å–æˆ¿é–“æ•¸æ“šå¤±æ•—");
          }

          const apiResponse = await response.json();

          if (!apiResponse.success) {
            throw new Error(apiResponse.message);
          }

          currentRoomData = apiResponse;

          // ä½¿ç”¨çœŸå¯¦æ•¸æ“šåˆå§‹åŒ–é é¢
          document.getElementById("courseTitle").textContent =
            currentRoomData.room.course_name;
          document.getElementById(
            "roomInfo"
          ).textContent = `æˆ¿é–“: ${currentRoomData.room.room_name} (ID: ${currentRoomData.room.room_id})`;

          // åŠ è¼‰æ•™æåˆ—è¡¨
          loadMaterials(currentRoomData.materials);

          // åŠ è¼‰æ¶ˆæ¯åˆ—è¡¨
          loadMessages(currentRoomData.messages);

          // åŠ è¼‰èª²ç¨‹çµ±è¨ˆ
          await loadCourseStats();

          // åŠ è¼‰å­¸ç”Ÿåˆ—è¡¨
          await loadStudents();

          // åŠ è¼‰ä½œæ¥­åˆ—è¡¨
          await loadHomeworkList();

          // é¡¯ç¤ºé»˜èªå€åŸŸ
          showSection("materials");

          // è¨­å®šé è¨­æ™‚é–“
          setDefaultDateTime();

          // è¼‰å…¥ Zoom æœƒè­°åˆ—è¡¨
          await loadZoomMeetings();

          // æ¨¡æ“¬å¯¦æ™‚æ¶ˆæ¯æ›´æ–°
          setInterval(() => {
            if (Math.random() > 0.7) {
              const sampleMessages = [
                "è€å¸«ï¼Œè«‹å•ä½œæ¥­ä»€éº¼æ™‚å€™äº¤ï¼Ÿ",
                "é€™å€‹æ¦‚å¿µæˆ‘ä¸å¤ªæ˜ç™½ï¼Œå¯ä»¥å†è§£é‡‹ä¸€æ¬¡å—ï¼Ÿ",
                "è¬è¬è€å¸«çš„è§£ç­”ï¼",
                "è«‹å•ä¸‹é€±çš„èª²ç¨‹æœƒè¬›ä»€éº¼å…§å®¹ï¼Ÿ",
              ];

              const randomMessage =
                sampleMessages[
                  Math.floor(Math.random() * sampleMessages.length)
                ];
              const randomUser = ["å­¸ç”ŸA", "å­¸ç”ŸB", "å­¸ç”ŸC"][
                Math.floor(Math.random() * 3)
              ];

              addMessageToChat(randomUser, randomMessage, false);
            }
          }, 15000);
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±æ•—:", error);
          showNotification("åŠ è¼‰èª²ç¨‹æ•¸æ“šå¤±æ•—: " + error.message, "error");
        }
      }

      function showSection(sectionId, clickedElement) {
        document.querySelectorAll(".section").forEach((el) => {
          el.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");

        // æ›´æ–°å´é‚Šæ¬„æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll("aside button").forEach((btn) => {
          btn.classList.remove("bg-blue-50", "text-blue-700");
        });

        // å®‰å…¨åœ°æ›´æ–°é»æ“Šå˜…æŒ‰éˆ•ç‹€æ…‹
        if (clickedElement) {
          clickedElement.classList.add("bg-blue-50", "text-blue-700");
        }

        // å¦‚æœåˆ‡æ›åˆ°ä½œæ¥­èˆ‡æ¸¬é©—ï¼Œé‡æ–°åŠ è¼‰ä½œæ¥­åˆ—è¡¨
        if (sectionId === "homework") {
          loadHomeworkList();
        }

        // å¦‚æœåˆ‡æ›åˆ°å­¸ç”Ÿç®¡ç†ï¼Œé‡æ–°åŠ è¼‰å­¸ç”Ÿåˆ—è¡¨
        if (sectionId === "students") {
          loadStudents();
        }

        // å¦‚æœåˆ‡æ›åˆ°æ–‡ä»¶æ‰¹æ”¹ï¼Œé‡æ–°åŠ è¼‰ä½œæ¥­åˆ—è¡¨
        if (sectionId === "documents") {
          loadDocumentsList();
        }
      }

      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          fetch("/logout", {
            method: "POST",
            credentials: "include",
            headers: {
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              showNotification(data.message || "å·²æˆåŠŸç™»å‡º", "success");

              // å¾¹åº•æ¸…é™¤æ‰€æœ‰å„²å­˜å’Œç·©å­˜
              sessionStorage.clear();
              localStorage.clear();

              // æ¸…é™¤è¡¨å–®æ•¸æ“šå’Œç·©å­˜
              if ("caches" in window) {
                caches.keys().then(function (names) {
                  for (let name of names) {
                    caches.delete(name);
                  }
                });
              }

              // å¼·åˆ¶é‡å®šå‘åˆ°ç™»å…¥é ï¼Œé˜²æ­¢è¿”å›
              setTimeout(() => {
                // ä½¿ç”¨ replace ä¸¦æ·»åŠ éš¨æ©Ÿåƒæ•¸é˜²æ­¢ç·©å­˜
                const randomParam = "t=" + new Date().getTime();
                window.location.replace("/?" + randomParam);
              }, 1000);
            })
            .catch((err) => {
              console.error("ç™»å‡ºéŒ¯èª¤:", err);
              // å³ä½¿å‡ºéŒ¯ä¹Ÿå¾¹åº•é‡å®šå‘
              sessionStorage.clear();
              localStorage.clear();
              window.location.replace("/?" + "t=" + new Date().getTime());
            });
        }
      }

      function goBack() {
        window.location.href = "/teacher";
      }

      // æ•™æç®¡ç†åŠŸèƒ½
      async function uploadMaterial() {
        const fileInput = document.getElementById("materialFile");
        const titleInput = document.getElementById("materialTitle");
        const typeSelect = document.getElementById("materialType");

        if (!fileInput.files.length) {
          showNotification("è«‹é¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶", "error");
          return;
        }

        if (!titleInput.value.trim()) {
          showNotification("è«‹è¼¸å…¥æ•™ææ¨™é¡Œ", "error");
          return;
        }

        if (!typeSelect.value) {
          showNotification("è«‹é¸æ“‡æ•™æé¡å‹", "error");
          return;
        }

        try {
          // å‰µå»ºFormDataå°è±¡
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          formData.append("title", titleInput.value);
          formData.append("type", typeSelect.value);

          // ä½¿ç”¨æ–°çš„ä¸Šå‚³ç«¯é»
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/material-upload`,
            {
              method: "POST",
              body: formData,
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ä¸Šå‚³å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          // é‡æ–°åŠ è¼‰æ•™æåˆ—è¡¨
          const roomResponse = await fetch(`/room/${currentCourseId}`, {
            method: "GET",
            credentials: "include",
          });

          if (roomResponse.ok) {
            const roomData = await roomResponse.json();
            if (roomData.success) {
              currentRoomData.materials = roomData.materials;
              loadMaterials(currentRoomData.materials);
            }
          }

          // æ¸…ç©ºè¡¨å–®
          fileInput.value = "";
          titleInput.value = "";
          typeSelect.value = "";

          showNotification("æ•™æä¸Šå‚³æˆåŠŸï¼", "success");
        } catch (error) {
          console.error("ä¸Šå‚³æ•™æéŒ¯èª¤:", error);
          showNotification("æ•™æä¸Šå‚³å¤±æ•—: " + error.message, "error");
        }
      }

      function loadMaterials(materials) {
        const materialsList = document.getElementById("materialsList");
        const materialCount = document.getElementById("materialCount");

        materialCount.textContent = materials.length;

        if (materials.length === 0) {
          materialsList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-4">
              <i class="fas fa-folder-open"></i>
            </div>
            <p>æš«ç„¡æ•™æ</p>
            <p class="text-sm mt-1">ä½¿ç”¨å·¦å´è¡¨å–®ä¸Šå‚³æ•™æ</p>
          </div>
        `;
          return;
        }

        materialsList.innerHTML = "";

        materials.forEach((material) => {
          const materialElement = document.createElement("div");
          materialElement.className =
            "material-card bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center";
          materialElement.innerHTML = `
          <div class="flex items-center">
            <div class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">
              <i class="fas fa-file-${
                material.type === "è¦–é »"
                  ? "video"
                  : material.type === "ç·´ç¿’é¡Œ"
                  ? "word"
                  : "pdf"
              }"></i>
            </div>
            <div>
              <h4 class="font-medium text-gray-800">${material.title}</h4>
              <p class="text-sm text-gray-500">${material.type} â€¢ ${new Date(
            material.created_at
          ).toLocaleDateString()}</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteMaterial(${
              material.id
            })" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
          materialsList.appendChild(materialElement);
        });
      }

      async function deleteMaterial(materialId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ•™æå—ï¼Ÿ")) {
          return;
        }

        try {
          // ç™¼é€åˆªé™¤è«‹æ±‚åˆ°æœå‹™ç«¯
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/material/${materialId}`,
            {
              method: "DELETE",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("åˆªé™¤å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          // å¾æœ¬åœ°æ•¸æ“šä¸­ç§»é™¤
          currentRoomData.materials = currentRoomData.materials.filter(
            (material) => material.id !== materialId
          );
          loadMaterials(currentRoomData.materials);
          showNotification("æ•™æå·²åˆªé™¤", "success");
        } catch (error) {
          console.error("åˆªé™¤æ•™æéŒ¯èª¤:", error);
          showNotification("åˆªé™¤å¤±æ•—: " + error.message, "error");
        }
      }

      // æ•™å¸«èŠå¤©åŠŸèƒ½
      async function sendTeacherMessage() {
        const input = document.getElementById("teacherMessageInput");
        const message = input.value.trim();

        if (!message) return;

        try {
          // ç™¼é€æ¶ˆæ¯åˆ°æœå‹™ç«¯
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/message`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ text: message }),
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ç™¼é€å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const chatMessages = document.getElementById("teacherChatMessages");
          if (chatMessages.children[0].classList.contains("text-center")) {
            chatMessages.innerHTML = "";
          }

          // æ·»åŠ æ•™å¸«æ¶ˆæ¯
          addMessageToChat(currentUser.username, message, true);

          // æ¸…ç©ºè¼¸å…¥æ¡†
          input.value = "";

          // æ»¾å‹•åˆ°åº•éƒ¨
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("ç™¼é€æ¶ˆæ¯éŒ¯èª¤:", error);
          showNotification("ç™¼é€å¤±æ•—: " + error.message, "error");
        }
      }

      function addMessageToChat(user, message, isTeacher) {
        const chatMessages = document.getElementById("teacherChatMessages");

        const messageDiv = document.createElement("div");
        messageDiv.className = `mb-4 ${
          isTeacher ? "flex justify-end" : "flex justify-start"
        }`;

        if (!isTeacher) {
          messageDiv.innerHTML = `
          <div class="flex items-start space-x-3 max-w-xs lg:max-w-md">
            <div class="bg-gray-100 p-2 rounded-full">
              <i class="fas fa-user text-gray-600"></i>
            </div>
            <div>
              <div class="bg-gray-200 rounded-lg p-3">
                <p class="text-sm font-medium text-gray-800">${user}</p>
                <p class="text-gray-700 mt-1">${message}</p>
              </div>
              <p class="text-xs text-gray-500 mt-1">å‰›å‰›</p>
            </div>
          </div>
        `;
        } else {
          messageDiv.innerHTML = `
          <div class="bg-blue-100 rounded-lg p-3 max-w-xs lg:max-w-md">
            <div class="flex items-center mb-1">
              <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">æ•™å¸«</span>
              <span class="text-xs text-gray-500 ml-2">${user}</span>
            </div>
            <p class="text-blue-800">${message}</p>
            <p class="text-xs text-blue-600 text-right mt-1">å‰›å‰›</p>
          </div>
        `;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function loadMessages(messages) {
        const chatMessages = document.getElementById("teacherChatMessages");

        if (messages.length === 0) {
          return;
        }

        chatMessages.innerHTML = "";

        messages.forEach((message) => {
          const isTeacher =
            message.role === "teacher" || message.user_id === currentUser.id;
          addMessageToChat(message.username || "ç”¨æˆ¶", message.text, isTeacher);
        });
      }

      // èª²ç¨‹çµ±è¨ˆåŠŸèƒ½
      // === Zoom æœƒè­°åŠŸèƒ½ ===

      async function createZoomMeeting() {
        const titleInput = document.getElementById("liveTitle");
        const dateTimeInput = document.getElementById("liveDateTime");
        const durationInput = document.getElementById("liveDuration");
        const descriptionInput = document.getElementById("liveDescription");
        const startBtn = document.getElementById("startLiveBtn");
        const meetingInfo = document.getElementById("meetingInfo");

        // é©—è­‰è¼¸å…¥
        if (!titleInput.value.trim()) {
          showNotification("âŒ è«‹è¼¸å…¥èª²å ‚æ¨™é¡Œ", "error");
          return;
        }

        if (!dateTimeInput.value) {
          showNotification("âŒ è«‹é¸æ“‡èª²å ‚æ™‚é–“", "error");
          return;
        }

        // æª¢æŸ¥æ™‚é–“æ˜¯å¦æ˜¯æœªä¾†æ™‚é–“
        const selectedTime = new Date(dateTimeInput.value);
        const now = new Date();
        if (selectedTime <= now) {
          showNotification("âŒ è«‹é¸æ“‡æœªä¾†çš„æ™‚é–“", "error");
          return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        startBtn.disabled = true;
        startBtn.innerHTML = `
          <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
          å‰µå»ºä¸­...
        `;

        try {
          const response = await fetch("/api/create-zoom-meeting", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              title: titleInput.value.trim(),
              startTime: dateTimeInput.value,
              duration: parseInt(durationInput.value) || 60,
              description: descriptionInput.value.trim(),
            }),
            credentials: "include",
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || "å‰µå»ºæœƒè­°å¤±æ•—");
          }

          // é¡¯ç¤ºæœƒè­°è³‡è¨Š
          const meeting = result.meeting;
          document.getElementById("meetingId").textContent = meeting.meetingId;
          document.getElementById("meetingPassword").textContent =
            meeting.password;

          // è¨­ç½®åŠ å…¥æœƒè­°æŒ‰éˆ•
          const joinBtn = document.getElementById("joinMeetingBtn");
          joinBtn.onclick = () => window.open(meeting.joinUrl, "_blank");

          meetingInfo.classList.remove("hidden");
          showNotification("âœ… Zoom æœƒè­°å‰µå»ºæˆåŠŸï¼", "success");

          // é‡ç½®æŒ‰éˆ•
          startBtn.disabled = false;
          startBtn.innerHTML = `
            <i class="fas fa-video mr-2"></i>å‰µå»º Zoom æœƒè­°
          `;

          // æ¸…ç©ºè¡¨å–®
          titleInput.value = "";
          dateTimeInput.value = "";
          durationInput.value = "60";
          descriptionInput.value = "";

          // è¼‰å…¥æœƒè­°åˆ—è¡¨
          await loadZoomMeetings();
        } catch (error) {
          console.error("å‰µå»º Zoom æœƒè­°éŒ¯èª¤:", error);
          showNotification("âŒ " + error.message, "error");

          // é‡ç½®æŒ‰éˆ•
          startBtn.disabled = false;
          startBtn.innerHTML = `
            <i class="fas fa-video mr-2"></i>å‰µå»º Zoom æœƒè­°
          `;
        }
      }

      // è¼‰å…¥ Zoom æœƒè­°åˆ—è¡¨
      async function loadZoomMeetings() {
        try {
          const response = await fetch("/api/zoom-meetings", {
            method: "GET",
            credentials: "include",
          });

          const result = await response.json();

          if (result.success) {
            displayZoomMeetings(result.meetings);
          }
        } catch (error) {
          console.error("è¼‰å…¥æœƒè­°åˆ—è¡¨éŒ¯èª¤:", error);
        }
      }

      // é¡¯ç¤º Zoom æœƒè­°åˆ—è¡¨
      function displayZoomMeetings(meetings) {
        // å¯ä»¥åœ¨æœªä¾†å¢åŠ æœƒè­°åˆ—è¡¨é¡¯ç¤ºåŠŸèƒ½
        console.log("æ•™å¸«çš„æœƒè­°åˆ—è¡¨:", meetings);
      }

      // è¨­å®šé è¨­æ™‚é–“ç‚ºç•¶å‰æ™‚é–“
      function setDefaultDateTime() {
        const dateTimeInput = document.getElementById("liveDateTime");
        if (dateTimeInput) {
          const now = new Date();
          // è¨­å®šç‚ºä¸‹ä¸€å€‹å°æ™‚
          now.setHours(now.getHours() + 1);
          now.setMinutes(0);
          now.setSeconds(0);

          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, "0");
          const day = String(now.getDate()).padStart(2, "0");
          const hours = String(now.getHours()).padStart(2, "0");
          const minutes = String(now.getMinutes()).padStart(2, "0");

          dateTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
      }

      // === èª²ç¨‹çµ±è¨ˆåŠŸèƒ½ ===

      async function loadCourseStats() {
        try {
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/stats`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              document.getElementById("studentCount").textContent =
                result.stats.studentCount;
              document.getElementById("materialCount").textContent =
                result.stats.materialCount;
              document.getElementById("homeworkCount").textContent =
                result.stats.homeworkCount;
            }
          }
        } catch (error) {
          console.error("åŠ è¼‰èª²ç¨‹çµ±è¨ˆéŒ¯èª¤:", error);
          // ä½¿ç”¨é»˜èªå€¼
          document.getElementById("studentCount").textContent = "15";
          document.getElementById("materialCount").textContent =
            currentRoomData.materials.length;
          document.getElementById("homeworkCount").textContent = "0";
        }
      }

      // å­¸ç”Ÿç®¡ç†åŠŸèƒ½ - å¢å¼·éŒ¯èª¤è™•ç†ç‰ˆæœ¬
      async function loadStudents() {
        console.log("ğŸ‘¨â€ğŸ“ é–‹å§‹åŠ è¼‰å­¸ç”Ÿåˆ—è¡¨...");

        if (!currentRoomData || !currentRoomData.room) {
          console.error("âŒ åŠ è¼‰å­¸ç”Ÿå¤±æ•—: æˆ¿é–“æ•¸æ“šæœªåˆå§‹åŒ–");
          showNotification("æˆ¿é–“æ•¸æ“šæœªåˆå§‹åŒ–ï¼Œè«‹åˆ·æ–°é é¢", "error");
          return;
        }

        const roomId = currentRoomData.room.room_id;
        console.log(`ğŸ” ä½¿ç”¨æˆ¿é–“ID: ${roomId} åŠ è¼‰å­¸ç”Ÿ`);

        try {
          const response = await fetch(`/room/${roomId}/students`, {
            method: "GET",
            credentials: "include",
          });

          console.log(`ğŸ“¡ å­¸ç”ŸAPIéŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);

          if (!response.ok) {
            const errorText = await response.text();
            console.error(
              `âŒ ç²å–å­¸ç”Ÿåˆ—è¡¨å¤±æ•—: ${response.status} - ${errorText}`
            );
            throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
          }

          const result = await response.json();
          console.log("ğŸ“Š å­¸ç”ŸAPIéŸ¿æ‡‰æ•¸æ“š:", result);

          if (!result.success) {
            console.error(`âŒ å­¸ç”ŸAPIè¿”å›éŒ¯èª¤: ${result.message}`);
            throw new Error(result.message || "ç²å–å­¸ç”Ÿåˆ—è¡¨å¤±æ•—");
          }

          const studentsTableBody =
            document.getElementById("studentsTableBody");

          if (!result.students || result.students.length === 0) {
            console.log("â„¹ï¸ æ²’æœ‰å­¸ç”Ÿæ•¸æ“š");
            studentsTableBody.innerHTML = `
        <tr>
          <td colspan="4" class="border px-4 py-6 text-center text-gray-500">
            <div class="text-4xl mb-2">
              <i class="fas fa-user-graduate"></i>
            </div>
            <p>æš«ç„¡å­¸ç”Ÿé¸èª²</p>
            <p class="text-sm mt-1">å­¸ç”Ÿé¸èª²å¾Œå°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
            <div class="mt-4 text-xs text-blue-500">
              èª²ç¨‹: ${result.roomInfo ? result.roomInfo.courseName : "æœªçŸ¥"}<br>
              æˆ¿é–“: ${result.roomInfo ? result.roomInfo.roomName : "æœªçŸ¥"}
            </div>
          </td>
        </tr>
      `;
            return;
          }

          console.log(`âœ… é¡¯ç¤º ${result.students.length} åå­¸ç”Ÿ`);
          studentsTableBody.innerHTML = "";

          result.students.forEach((student) => {
            const row = document.createElement("tr");
            row.className = "hover:bg-blue-50 transition-colors";
            row.innerHTML = `
        <td class="border px-4 py-3">
          <div class="flex items-center">
            <div class="bg-green-100 text-green-600 p-2 rounded-full mr-3">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div>
              <span class="font-medium">${student.username}</span>
              <p class="text-xs text-gray-500">å­¸ç”Ÿ ID: ${student.id}</p>
            </div>
          </div>
        </td>
        <td class="border px-4 py-3 text-center">
  ${
    student.last_enrolled
      ? `${new Date(student.last_enrolled).toLocaleDateString("zh-HK")}<br>
     <span class="text-xs text-gray-500">${new Date(
       student.last_enrolled
     ).toLocaleTimeString("zh-HK")}</span>`
      : '<span class="text-gray-400 text-sm">æ™‚é–“æœªçŸ¥</span>'
  }
</td>
        <td class="border px-4 py-3 text-center">
          <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-sm">${
            student.enrolled_courses
          } é–€èª²ç¨‹</span>
        </td>
        <td class="border px-4 py-3 text-center">
          <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-sm">${
            student.submitted_assignments || 0
          } å€‹ä½œæ¥­</span>
        </td>
      `;
            studentsTableBody.appendChild(row);
          });

          showNotification(
            `âœ… æˆåŠŸåŠ è¼‰ ${result.students.length} åå­¸ç”Ÿ`,
            "success"
          );
        } catch (error) {
          console.error("âŒ åŠ è¼‰å­¸ç”Ÿåˆ—è¡¨éŒ¯èª¤:", error);
          const studentsTableBody =
            document.getElementById("studentsTableBody");
          studentsTableBody.innerHTML = `
      <tr>
        <td colspan="4" class="border px-4 py-6 text-center text-red-500">
          <div class="text-4xl mb-2">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <p>è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—</p>
          <p class="text-sm mt-1">${error.message}</p>
          <button onclick="loadStudents()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
            <i class="fas fa-redo mr-2"></i>é‡æ–°è¼‰å…¥
          </button>
        </td>
      </tr>
    `;
        }
      }

      // ä½œæ¥­ç®¡ç†åŠŸèƒ½
      async function createHomework() {
        const titleInput = document.getElementById("homeworkTitle");
        const descriptionInput = document.getElementById("homeworkDescription");
        const deadlineInput = document.getElementById("homeworkDeadline");

        if (!titleInput.value.trim()) {
          showNotification("è«‹è¼¸å…¥ä½œæ¥­æ¨™é¡Œ", "error");
          return;
        }

        if (!deadlineInput.value) {
          showNotification("è«‹é¸æ“‡æˆªæ­¢æ—¥æœŸ", "error");
          return;
        }

        try {
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                title: titleInput.value,
                description: descriptionInput.value,
                deadline: deadlineInput.value,
              }),
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("å‰µå»ºä½œæ¥­å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          // æ¸…ç©ºè¡¨å–®
          titleInput.value = "";
          descriptionInput.value = "";
          deadlineInput.value = "";

          // é‡æ–°åŠ è¼‰ä½œæ¥­åˆ—è¡¨
          await loadHomeworkList();

          showNotification("ä½œæ¥­å‰µå»ºæˆåŠŸï¼", "success");
        } catch (error) {
          console.error("å‰µå»ºä½œæ¥­éŒ¯èª¤:", error);
          showNotification("ä½œæ¥­å‰µå»ºå¤±æ•—: " + error.message, "error");
        }
      }

      async function loadHomeworkList() {
        try {
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ç²å–ä½œæ¥­åˆ—è¡¨å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const homeworkList = document.getElementById("homeworkList");

          if (result.homework.length === 0) {
            homeworkList.innerHTML = `
            <div class="text-center py-4 text-gray-500">
              <p>æš«ç„¡ä½œæ¥­</p>
            </div>
          `;
            return;
          }

          homeworkList.innerHTML = "";

          result.homework.forEach((homework) => {
            const homeworkElement = document.createElement("div");
            homeworkElement.className =
              "flex justify-between p-3 border rounded-lg hover:bg-blue-50 transition-colors";
            homeworkElement.innerHTML = `
            <div>
              <span class="font-medium">${homework.title}</span>
              <p class="text-sm text-gray-500">æˆªæ­¢: ${new Date(
                homework.deadline
              ).toLocaleString()}</p>
            </div>
            <div class="flex space-x-2">
              <button onclick="viewSubmissions(${
                homework.id
              })" class="text-blue-600 hover:text-blue-800 text-sm">æŸ¥çœ‹æäº¤</button>
              <button onclick="deleteHomework(${
                homework.id
              })" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
            </div>
          `;
            homeworkList.appendChild(homeworkElement);
          });
        } catch (error) {
          console.error("åŠ è¼‰ä½œæ¥­åˆ—è¡¨éŒ¯èª¤:", error);
          const homeworkList = document.getElementById("homeworkList");
          homeworkList.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            <p>è¼‰å…¥ä½œæ¥­åˆ—è¡¨å¤±æ•—</p>
          </div>
        `;
        }
      }

      async function viewSubmissions(homeworkId) {
        try {
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework/${homeworkId}/submissions`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ç²å–ä½œæ¥­æäº¤å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const submissionList = document.getElementById("submissionList");

          if (result.submissions.length === 0) {
            submissionList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-4">
                <i class="fas fa-file-alt"></i>
              </div>
              <p>æš«ç„¡ä½œæ¥­æäº¤</p>
              <p class="text-sm mt-1">å­¸ç”Ÿå°šæœªæäº¤æ­¤ä½œæ¥­</p>
            </div>
          `;
            return;
          }

          submissionList.innerHTML = "";

          result.submissions.forEach((submission) => {
            const submissionElement = document.createElement("div");
            submissionElement.className =
              "p-4 border rounded-lg hover:bg-blue-50 transition-colors";
            submissionElement.innerHTML = `
            <div class="flex justify-between items-start mb-3">
              <div>
                <span class="font-medium">${submission.username}</span>
                <p class="text-sm text-gray-500">æäº¤æ™‚é–“: ${new Date(
                  submission.submitted_at
                ).toLocaleString()}</p>
              </div>
              <div class="flex items-center">
                ${
                  submission.grade
                    ? `
                  <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs mr-2">å·²è©•åˆ†: ${submission.grade}</span>
                `
                    : `
                  <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs mr-2">å¾…æ‰¹æ”¹</span>
                `
                }
                <button onclick="selectSubmission(${submission.id}, ${
              submission.grade || 0
            }, '${
              submission.feedback || ""
            }')" class="text-blue-600 hover:text-blue-800 text-sm">æ‰¹æ”¹</button>
              </div>
            </div>
            ${
              submission.file_url
                ? `
              <div class="mt-2">
                <a href="${submission.file_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                  <i class="fas fa-download mr-1"></i> ä¸‹è¼‰ä½œæ¥­æ–‡ä»¶
                </a>
              </div>
            `
                : ""
            }
          `;
            submissionList.appendChild(submissionElement);
          });
        } catch (error) {
          console.error("åŠ è¼‰ä½œæ¥­æäº¤éŒ¯èª¤:", error);
          const submissionList = document.getElementById("submissionList");
          submissionList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-4">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p>è¼‰å…¥ä½œæ¥­æäº¤å¤±æ•—</p>
            <p class="text-sm mt-1">${error.message}</p>
          </div>
        `;
        }
      }

      function selectSubmission(submissionId, grade, feedback) {
        currentSelectedSubmission = submissionId;
        document.getElementById("gradingScore").value = grade;
        document.getElementById("gradingFeedback").value = feedback || "";
        showNotification("å·²é¸æ“‡ä½œæ¥­æäº¤ï¼Œè«‹åœ¨å³å´é€²è¡Œæ‰¹æ”¹", "info");
      }

      async function saveGrading() {
        if (!currentSelectedSubmission) {
          showNotification("è«‹å…ˆé¸æ“‡è¦æ‰¹æ”¹çš„ä½œæ¥­", "error");
          return;
        }

        const score = document.getElementById("gradingScore").value;
        const feedback = document.getElementById("gradingFeedback").value;

        if (!score) {
          showNotification("è«‹è¼¸å…¥è©•åˆ†", "error");
          return;
        }

        try {
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework/${currentSelectedSubmission}/submission/${currentSelectedSubmission}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                grade: parseInt(score),
                feedback: feedback,
              }),
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ä¿å­˜æ‰¹æ”¹å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          showNotification("æ‰¹æ”¹å·²ä¿å­˜", "success");
        } catch (error) {
          console.error("ä¿å­˜æ‰¹æ”¹éŒ¯èª¤:", error);
          showNotification("ä¿å­˜æ‰¹æ”¹å¤±æ•—: " + error.message, "error");
        }
      }

      async function submitGrading() {
        await saveGrading();
        showNotification("æ‰¹æ”¹å›é¥‹å·²ç™¼é€çµ¦å­¸ç”Ÿ", "success");
      }

      async function loadDocumentsList() {
        // é€™è£¡å¯ä»¥åŠ è¼‰éœ€è¦æ‰¹æ”¹çš„ä½œæ¥­åˆ—è¡¨
        // ç›®å‰ä½¿ç”¨èˆ‡ä½œæ¥­èˆ‡æ¸¬é©—ç›¸åŒçš„æ•¸æ“š
        try {
          const response = await fetch(
            `/api/room/${currentRoomData.room.room_id}/homework`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("ç²å–ä½œæ¥­åˆ—è¡¨å¤±æ•—");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const documentsList = document.getElementById("documentsList");

          if (result.homework.length === 0) {
            documentsList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-4">
                <i class="fas fa-file-alt"></i>
              </div>
              <p>æš«ç„¡ä½œæ¥­</p>
              <p class="text-sm mt-1">åœ¨ä½œæ¥­èˆ‡æ¸¬é©—ä¸­ç™¼ä½ˆä½œæ¥­å¾Œï¼Œå­¸ç”Ÿæäº¤çš„ä½œæ¥­å°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
            </div>
          `;
            return;
          }

          documentsList.innerHTML = "";

          // ç‚ºæ¯å€‹ä½œæ¥­åŠ è¼‰æäº¤æƒ…æ³
          for (const homework of result.homework) {
            const submissionsResponse = await fetch(
              `/room/${currentRoomData.room.room_id}/homework/${homework.id}/submissions`,
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (submissionsResponse.ok) {
              const submissionsResult = await submissionsResponse.json();

              if (
                submissionsResult.success &&
                submissionsResult.submissions.length > 0
              ) {
                submissionsResult.submissions.forEach((submission) => {
                  const documentElement = document.createElement("div");
                  documentElement.className =
                    "p-4 border rounded-lg hover:bg-blue-50 cursor-pointer transition-colors";
                  documentElement.innerHTML = `
                  <div class="flex justify-between items-start">
                    <div>
                      <span class="font-medium">${submission.username} - ${
                    homework.title
                  }</span>
                      <p class="text-sm text-gray-500">æäº¤æ™‚é–“: ${new Date(
                        submission.submitted_at
                      ).toLocaleString()}</p>
                    </div>
                    <span class="${
                      submission.grade
                        ? "bg-green-100 text-green-800"
                        : "bg-yellow-100 text-yellow-800"
                    } px-2 py-1 rounded text-xs">
                      ${submission.grade ? "å·²æ‰¹æ”¹" : "å¾…æ‰¹æ”¹"}
                    </span>
                  </div>
                `;
                  documentElement.onclick = () => {
                    selectSubmission(
                      submission.id,
                      submission.grade || 0,
                      submission.feedback || ""
                    );
                    showSection("documents");
                  };
                  documentsList.appendChild(documentElement);
                });
              }
            }
          }

          if (documentsList.children.length === 0) {
            documentsList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-4">
                <i class="fas fa-file-alt"></i>
              </div>
              <p>æš«ç„¡ä½œæ¥­æäº¤</p>
              <p class="text-sm mt-1">å­¸ç”Ÿå°šæœªæäº¤ä»»ä½•ä½œæ¥­</p>
            </div>
          `;
          }
        } catch (error) {
          console.error("åŠ è¼‰æ–‡æª”åˆ—è¡¨éŒ¯èª¤:", error);
          const documentsList = document.getElementById("documentsList");
          documentsList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-4">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p>è¼‰å…¥ä½œæ¥­åˆ—è¡¨å¤±æ•—</p>
            <p class="text-sm mt-1">${error.message}</p>
          </div>
        `;
        }
      }

      function showNotification(message, type) {
        const notificationArea = document.getElementById("notificationArea");
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);

        // é¡¯ç¤ºé€šçŸ¥
        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        // éš±è—é€šçŸ¥
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notificationArea.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      window.addEventListener("load", function () {
        fetch("/check-auth", {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache, no-store, must-revalidate",
            Pragma: "no-cache",
            Expires: "0",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              // æœªç™»å…¥ï¼Œç«‹å³é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
              document.body.innerHTML = `
              <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
                <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                  <h1 style="color: #ef4444; margin-bottom: 1rem;">âš ï¸ æœªæˆæ¬Šè¨ªå•</h1>
                  <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">${JSON.stringify(
                    data,
                    null,
                    2
                  )}</pre>
                  <p style="margin-top: 1rem; color: #6b7280;">
                    <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                  </p>
                </div>
              </div>
            `;
              return;
            }
            // æ¬Šé™é©—è­‰é€šéï¼Œåˆå§‹åŒ–æ•™å¸«æˆ¿é–“é é¢
            initTeacherRoom();
          })
          .catch((error) => {
            console.error("èªè­‰æª¢æŸ¥éŒ¯èª¤:", error);
            document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
              <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                <h1 style="color: #ef4444; margin-bottom: 1rem;">âŒ é€£æ¥éŒ¯èª¤</h1>
                <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">{"success": false, "message": "è«‹å…ˆç™»å…¥ç³»çµ±"}</pre>
                <p style="margin-top: 1rem; color: #6b7280;">
                  <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                </p>
              </div>
            </div>
          `;
          });
      });

      // é˜²æ­¢ä½¿ç”¨ç€è¦½å™¨è¿”å›æŒ‰éˆ•
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      });

      // åˆå§‹åŒ–æ•™å¸«æˆ¿é–“é é¢çš„å‡½æ•¸
      function initTeacherRoom() {
        console.log("ğŸ”§ åˆå§‹åŒ–æ•™å¸«æˆ¿é–“é é¢");
        init();
      }

      // åˆå§‹åŒ–é é¢ (ç¾åœ¨åªæ˜¯ä¿ç•™ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ)
      document.addEventListener("DOMContentLoaded", function () {
        // æ‰€æœ‰åˆå§‹åŒ–å·²ç§»è‡³ load äº‹ä»¶çš„æ¬Šé™æª¢æŸ¥å¾ŒåŸ·è¡Œ
        console.log("ğŸ“„ DOM å…§å®¹å·²è¼‰å…¥ï¼Œç­‰å¾…æ¬Šé™é©—è­‰...");
      });
    </script>
  </body>
</html>
