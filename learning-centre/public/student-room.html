<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <title>SmartEdu å­¸ç”Ÿå°ˆå€ - èª²ç¨‹æˆ¿é–“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Word docx support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <!-- PDF support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .section {
        display: none;
      }
      .section.active {
        display: block;
      }
      .message-container {
        max-height: 400px;
        overflow-y: auto;
      }
      .material-card {
        transition: all 0.3s ease;
      }
      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .progress-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #e5e7eb;
      }
      .progress-fill {
        height: 100%;
        transition: width 0.5s ease;
      }
      .typing-indicator {
        display: none;
      }
      .typing-indicator.active {
        display: block;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.info {
        background-color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Navbar -->
    <header
      class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 flex justify-between items-center shadow-lg"
    >
      <div class="flex items-center space-x-4">
        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
          <span class="text-xl">ğŸ“š</span>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-wide" id="courseTitle">
            SmartEdu å­¸ç”Ÿå°ˆå€
          </h1>
          <span class="text-sm text-blue-200" id="teacherName"></span>
        </div>
      </div>
      <nav class="flex space-x-6 text-sm">
        <button
          onclick="showSection('lesson')"
          class="px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-book mr-2"></i>ä¸Šå ‚å°ˆå€
        </button>
        <button
          onclick="showSection('study')"
          class="px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-pencil-alt mr-2"></i>å­¸ç¿’å°ˆå€
        </button>
        <button
          onclick="showSection('review')"
          class="px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-video mr-2"></i>èª²å ‚é‡æº«
        </button>
        <button
          onclick="showSection('document')"
          class="px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-file-alt mr-2"></i>æ–‡ä»¶è™•ç†
        </button>
        <button
          onclick="showSection('chat')"
          class="px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
        >
          <i class="fas fa-comments mr-2"></i>äº’å‹•èŠå¤©å®¤
        </button>
      </nav>
      <div class="flex items-center space-x-4">
        <span id="userDisplay">ğŸ‘©ğŸ»â€ğŸ“ è¼‰å…¥ä¸­...</span>
        <button
          onclick="logout()"
          class="bg-red-500 px-3 py-2 rounded hover:bg-red-600 transition-colors"
        >
          ç™»å‡º
        </button>
        <button
          onclick="goBack()"
          class="bg-gray-500 px-3 py-2 rounded hover:bg-gray-600 transition-colors"
        >
          è¿”å›èª²ç¨‹åˆ—è¡¨
        </button>
      </div>
    </header>

    <!-- Notification Area -->
    <div id="notificationArea"></div>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-8 space-y-10">
      <!-- ä¸Šå ‚å°ˆå€ -->
      <div id="lesson" class="section active">
        <h2
          class="text-3xl font-semibold text-blue-900 mb-6 border-b pb-2 flex items-center"
        >
          <i class="fas fa-book mr-3 text-blue-500"></i>
          ä¸Šå ‚å°ˆå€
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
              <i class="fas fa-file-alt mr-2"></i>èª²ç¨‹æ•™æ
            </h3>
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
              <p class="text-sm text-blue-700 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                è€å¸«æœƒåœ¨æ­¤è™•ä¸Šå‚³èª²ç¨‹ç›¸é—œæ•™æï¼Œè«‹å®šæœŸæŸ¥çœ‹æ›´æ–°
              </p>
            </div>
            <ul id="materialsList" class="space-y-3">
              <li class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-4">
                  <i class="fas fa-folder-open"></i>
                </div>
                <p>è¼‰å…¥æ•™æä¸­...</p>
              </li>
            </ul>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
              <i class="fas fa-video mr-2"></i>ç›´æ’­èª²å ‚
            </h3>
            <div
              class="aspect-video bg-gray-800 flex items-center justify-center text-white rounded-lg mb-4"
            >
              <div class="text-center">
                <div class="text-5xl mb-4">
                  <i class="fas fa-play-circle"></i>
                </div>
                <p class="text-xl font-medium">ç›´æ’­èª²å ‚å°‡æ–¼ä¸Šèª²æ™‚é–“é–‹å§‹</p>
                <p class="text-blue-200 mt-2">ä¸‹æ¬¡ç›´æ’­: ä»Šæ—¥ 14:00</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button
                class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>åŠ å…¥ç›´æ’­
              </button>
              <button
                class="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-volume-up mr-2"></i>æ¸¬è©¦éŸ³è¨Š
              </button>
            </div>
            <div
              class="mt-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200"
            >
              <p class="text-sm text-yellow-700 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                è«‹æå‰10åˆ†é˜é€²å…¥ç›´æ’­é–“æ¸¬è©¦è¨­å‚™
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- å­¸ç¿’å°ˆå€ -->
      <div id="study" class="section">
        <h2
          class="text-3xl font-semibold text-blue-900 mb-6 border-b pb-2 flex items-center"
        >
          <i class="fas fa-pencil-alt mr-3 text-blue-500"></i>
          å­¸ç¿’å°ˆå€
        </h2>
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Sidebar -->
          <div class="lg:w-64 bg-white p-6 rounded-xl shadow-lg space-y-6">
            <div>
              <h3
                class="text-lg font-bold text-blue-800 mb-3 flex items-center"
              >
                <i class="fas fa-upload mr-2"></i>ä¸Šè¼‰ä½œæ¥­
              </h3>
              <div class="mb-3">
                <select
                  id="homeworkSelect"
                  class="w-full border rounded-lg p-2 text-sm mb-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                >
                  <option value="">é¸æ“‡ä½œæ¥­</option>
                </select>
                <input
                  type="file"
                  id="homeworkFile"
                  class="w-full border rounded-lg p-2 text-sm"
                />
              </div>
              <button
                onclick="uploadHomework()"
                class="w-full bg-blue-700 text-white px-3 py-2 rounded-lg hover:bg-blue-800 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šè¼‰ä½œæ¥­
              </button>
            </div>

            <div class="border-t pt-4">
              <h3
                class="text-lg font-bold text-blue-800 mb-3 flex items-center"
              >
                <i class="fas fa-chart-line mr-2"></i>å­¸ç¿’é€²åº¦
              </h3>
              <div class="space-y-4">
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span>æ•™æé–±è®€</span>
                    <span class="text-green-600 font-medium">75%</span>
                  </div>
                  <div class="progress-bar">
                    <div
                      class="progress-fill bg-green-500"
                      style="width: 75%"
                    ></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span>ä½œæ¥­å®Œæˆ</span>
                    <span class="text-yellow-600 font-medium">50%</span>
                  </div>
                  <div class="progress-bar">
                    <div
                      class="progress-fill bg-yellow-500"
                      style="width: 50%"
                    ></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span>æ¸¬é©—æˆç¸¾</span>
                    <span class="text-blue-600 font-medium">85%</span>
                  </div>
                  <div class="progress-bar">
                    <div
                      class="progress-fill bg-blue-500"
                      style="width: 85%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main content -->
          <div class="flex-1 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3
                class="text-xl font-bold text-blue-800 mb-4 flex items-center"
              >
                <i class="fas fa-question-circle mr-2"></i>è‡ªå‹•ç”Ÿæˆè©¦é¡Œ
              </h3>
              <p class="text-gray-600 mb-4">
                ç³»çµ±æœƒæ ¹æ“šèª²ç¨‹å…§å®¹ç”Ÿæˆç·´ç¿’é¡Œç›®ï¼Œå¹«åŠ©æ‚¨éå›ºçŸ¥è­˜é»
              </p>
              <div id="generatedQuestions" class="space-y-4">
                <div class="p-4 border rounded-lg">
                  <p class="font-medium mb-2">1. è«‹è§£é‡‹æœ¬èª²ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Ÿ</p>
                  <textarea
                    class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    rows="3"
                    placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ..."
                  ></textarea>
                </div>
                <div class="p-4 border rounded-lg">
                  <p class="font-medium mb-2">2. è«‹åˆ—å‡ºä¸‰å€‹é‡è¦çš„å­¸ç¿’è¦é»ï¼Ÿ</p>
                  <textarea
                    class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    rows="3"
                    placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ..."
                  ></textarea>
                </div>
              </div>
              <button
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center"
              >
                <i class="fas fa-paper-plane mr-2"></i>æäº¤ç­”æ¡ˆ
              </button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
              <h3
                class="text-xl font-bold text-blue-800 mb-4 flex items-center"
              >
                <i class="fas fa-robot mr-2"></i>AI å­¸ç¿’åŠ©æ‰‹
              </h3>
              <textarea
                id="aiQuestion"
                class="w-full border rounded-lg p-3 text-sm mb-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                rows="4"
                placeholder="é—œæ–¼èª²ç¨‹çš„ä»»ä½•å•é¡Œ..."
              ></textarea>
              <button
                onclick="askAI()"
                class="w-full bg-purple-600 text-white px-3 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-comment mr-2"></i>è©¢å• AI åŠ©æ‰‹
              </button>
              <div
                id="aiResponse"
                class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200 hidden"
              >
                <!-- AI å›ç­”å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- èª²å ‚é‡æº« -->
      <div id="review" class="section">
        <h2
          class="text-3xl font-semibold text-blue-900 mb-6 border-b pb-2 flex items-center"
        >
          <i class="fas fa-video mr-3 text-blue-500"></i>
          èª²å ‚é‡æº«
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="text-blue-700 font-semibold mb-2">èª²ç¨‹éŒ„å½± #1</h3>
            <div
              class="aspect-video bg-gray-800 flex items-center justify-center text-white rounded-lg mb-3"
            >
              <div class="text-center">
                <div class="text-4xl mb-2">
                  <i class="fas fa-play-circle"></i>
                </div>
                <p class="text-sm">éŒ„å½±å›æ”¾</p>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">2å°æ™‚15åˆ†é˜</span>
              <button
                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors"
              >
                è§€çœ‹
              </button>
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="text-blue-700 font-semibold mb-2">èª²ç¨‹éŒ„å½± #2</h3>
            <div
              class="aspect-video bg-gray-800 flex items-center justify-center text-white rounded-lg mb-3"
            >
              <div class="text-center">
                <div class="text-4xl mb-2">
                  <i class="fas fa-play-circle"></i>
                </div>
                <p class="text-sm">éŒ„å½±å›æ”¾</p>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">1å°æ™‚45åˆ†é˜</span>
              <button
                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors"
              >
                è§€çœ‹
              </button>
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="text-blue-700 font-semibold mb-2">é‡é»ç­†è¨˜</h3>
            <div
              class="aspect-video bg-yellow-50 flex items-center justify-center text-yellow-600 rounded-lg border-2 border-yellow-200 mb-3"
            >
              <div class="text-center">
                <div class="text-4xl mb-2">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <p class="text-sm">èª²ç¨‹é‡é»æ‘˜è¦</p>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">PDF æ–‡ä»¶</span>
              <button
                class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition-colors"
              >
                ä¸‹è¼‰
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ–‡ä»¶è™•ç† -->
      <div id="document" class="section">
        <h2
          class="text-3xl font-semibold text-blue-900 mb-6 border-b pb-2 flex items-center"
        >
          <i class="fas fa-file-alt mr-3 text-blue-500"></i>
          æ–‡ä»¶è™•ç†
        </h2>
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Sidebar -->
          <div class="lg:w-64 bg-white p-6 rounded-xl shadow-lg space-y-6">
            <div>
              <h3
                class="text-lg font-bold text-blue-800 mb-3 flex items-center"
              >
                <i class="fas fa-globe mr-2"></i>é¸æ“‡èªè¨€
              </h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm text-gray-700 mb-1"
                    >ä¾†æºèªè¨€</label
                  >
                  <select
                    id="langFrom"
                    class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  >
                    <option value="en">è‹±æ–‡</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ja">æ—¥æ–‡</option>
                    <option value="ko">éŸ“æ–‡</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-gray-700 mb-1"
                    >ç›®æ¨™èªè¨€</label
                  >
                  <select
                    id="langTo"
                    class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  >
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">è‹±æ–‡</option>
                    <option value="ja">æ—¥æ–‡</option>
                    <option value="ko">éŸ“æ–‡</option>
                  </select>
                </div>
              </div>
            </div>

            <div>
              <h3
                class="text-lg font-bold text-blue-800 mb-3 flex items-center"
              >
                <i class="fas fa-upload mr-2"></i>ä¸Šå‚³æ–‡ä»¶
              </h3>
              <input
                type="file"
                id="fileInput"
                accept=".txt,.docx,.pdf"
                class="w-full text-sm mb-3"
              />
              <button
                onclick="uploadFile()"
                class="w-full bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-language mr-2"></i>ä¸Šè¼‰ä¸¦ç¿»è­¯æª”æ¡ˆ
              </button>
            </div>

            <div>
              <button
                onclick="exportFile()"
                class="w-full bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-download mr-2"></i>å°å‡ºæ–‡ä»¶
              </button>
            </div>
          </div>

          <!-- ç¿»è­¯é è¦½ -->
          <div class="flex-1 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
              <i class="fas fa-eye mr-2"></i>ç¿»è­¯é è¦½
            </h3>
            <div
              id="preview"
              class="space-y-4 text-sm leading-relaxed max-h-96 overflow-y-auto p-4 border rounded-lg"
            >
              <div class="text-center py-8 text-gray-400">
                <div class="text-4xl mb-4">
                  <i class="fas fa-file-import"></i>
                </div>
                <p>è«‹ä¸Šè¼‰ .txt / .docx / .pdf æª”æ¡ˆ</p>
                <p class="text-sm mt-1">ç„¶å¾Œæœƒåœ¨é€™è£¡é€è¡Œé¡¯ç¤ºåŸæ–‡èˆ‡ç¿»è­¯</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- äº’å‹•èŠå¤©å®¤ -->
      <div id="chat" class="section">
        <h2
          class="text-3xl font-semibold text-blue-900 mb-6 border-b pb-2 flex items-center"
        >
          <i class="fas fa-comments mr-3 text-blue-500"></i>
          äº’å‹•èŠå¤©å®¤
        </h2>
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
            <h3 class="font-semibold text-blue-800">èª²ç¨‹è¨è«–å€</h3>
            <p class="text-sm text-gray-600">èˆ‡åŒå­¸å’Œè€å¸«äº¤æµå­¸ç¿’å•é¡Œ</p>
          </div>

          <div class="p-4 h-96 overflow-y-auto border-b" id="chatMessages">
            <div class="text-center text-gray-500 py-8">
              <div class="text-4xl mb-2">ğŸ’¬</div>
              <p>é–‹å§‹èˆ‡èª²ç¨‹æˆå“¡å°è©±</p>
            </div>
          </div>

          <div class="p-4">
            <div
              class="typing-indicator mb-2 text-sm text-gray-500"
              id="typingIndicator"
            >
              <span id="typingUser">æŸäºº</span> æ­£åœ¨è¼¸å…¥...
            </div>
            <div class="flex space-x-2">
              <input
                type="text"
                id="messageInput"
                placeholder="è¼¸å…¥è¨Šæ¯..."
                class="flex-1 border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
              <button
                onclick="sendMessage()"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center"
              >
                <i class="fas fa-paper-plane mr-2"></i>ç™¼é€
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Script -->
    <script>
      // å…¨å±€å˜é‡
      let currentRoomData = null;
      let currentUser = null;
      let currentCourseId = null;
      let homeworkList = [];

      // åˆå§‹åŒ–é¡µé¢
      async function init() {
        try {
          console.log("å¼€å§‹åˆå§‹åŒ–é¡µé¢...");

          // ä»URLè·å–è¯¾ç¨‹ID
          const pathSegments = window.location.pathname.split("/");
          currentCourseId = pathSegments[pathSegments.length - 1];

          if (!currentCourseId || isNaN(currentCourseId)) {
            showNotification("æ— æ•ˆçš„è¯¾ç¨‹ID", "error");
            return;
          }

          console.log("è¯¾ç¨‹ID:", currentCourseId);

          // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
          const authResponse = await fetch("/check-auth", {
            method: "GET",
            credentials: "include",
          });

          if (!authResponse.ok) {
            throw new Error("ç”¨æˆ·æœªç™»å½•");
          }

          const authData = await authResponse.json();

          if (!authData.success) {
            window.location.href = "/";
            return;
          }

          currentUser = authData.user;
          document.getElementById("userDisplay").textContent =
            "ğŸ‘©ğŸ»â€ğŸ“ " + currentUser.username;

          console.log("ç”¨æˆ·ä¿¡æ¯:", currentUser);

          // ä»æœåŠ¡ç«¯è·å–æˆ¿é—´æ•°æ®
          const response = await fetch(`/room/${currentCourseId}`, {
            method: "GET",
            credentials: "include",
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `è·å–æˆ¿é—´æ•°æ®å¤±è´¥: ${response.status} - ${errorText}`
            );
          }

          const apiResponse = await response.json();

          if (!apiResponse.success) {
            throw new Error(apiResponse.message);
          }

          currentRoomData = apiResponse;
          console.log("æˆ¿é—´æ•°æ®:", currentRoomData);

          // ä½¿ç”¨çœŸå®æ•°æ®åˆå§‹åŒ–é¡µé¢
          document.getElementById("courseTitle").textContent =
            currentRoomData.room.course_name;
          document.getElementById("teacherName").textContent =
            "æ•™å¸«: " + currentRoomData.room.teacher_name;

          // åŠ è½½æ•™æ
          loadCourseMaterials(currentRoomData.materials);

          // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
          loadMessages(currentRoomData.messages);

          // åŠ è½½ä½œä¸šåˆ—è¡¨
          await loadHomeworkList();

          // æ˜¾ç¤ºé»˜è®¤åŒºåŸŸ
          showSection("lesson");

          console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ");
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±è´¥:", error);
          showNotification("åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥: " + error.message, "error");
        }
      }

      function showSection(id) {
        try {
          document.querySelectorAll(".section").forEach((sec) => {
            sec.classList.remove("active");
          });

          const targetSection = document.getElementById(id);
          if (targetSection) {
            targetSection.classList.add("active");
          }

          // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
          document.querySelectorAll("nav button").forEach((btn) => {
            btn.classList.remove("bg-blue-700");
          });

          // å®‰å…¨åœ°æ·»åŠ æ´»åŠ¨ç±»
          if (event && event.target) {
            event.target.classList.add("bg-blue-700");
          }
        } catch (error) {
          console.error("åˆ‡æ¢åŒºåŸŸé”™è¯¯:", error);
        }
      }

      function logout() {
        fetch("/logout", {
          method: "POST",
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            showNotification(data.message || "å·²æˆåŠŸç™»å‡º", "success");
            setTimeout(() => {
              window.location.href = "/";
            }, 1500);
          })
          .catch((err) => {
            console.error("ç™»å‡ºé”™è¯¯:", err);
            showNotification("ç™»å‡ºå¤±è´¥", "error");
          });
      }

      function goBack() {
        window.location.href = "/student";
      }

      // ä½œä¸šæäº¤åŠŸèƒ½
      async function uploadHomework() {
        const homeworkSelect = document.getElementById("homeworkSelect");
        const fileInput = document.getElementById("homeworkFile");

        if (!homeworkSelect || !homeworkSelect.value) {
          showNotification("è«‹é¸æ“‡ä½œæ¥­", "error");
          return;
        }

        if (!fileInput || !fileInput.files || !fileInput.files.length) {
          showNotification("è«‹é¸æ“‡è¦ä¸Šè¼‰çš„ä½œæ¥­æ–‡ä»¶", "error");
          return;
        }

        try {
          // åˆ›å»ºFormDataå¯¹è±¡
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);

          // å‘é€è¯·æ±‚åˆ°æœåŠ¡ç«¯
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework/${homeworkSelect.value}/submit`,
            {
              method: "POST",
              body: formData,
              credentials: "include",
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${errorText}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          showNotification("ä½œæ¥­ä¸Šè¼‰æˆåŠŸï¼", "success");
          fileInput.value = "";
        } catch (error) {
          console.error("æäº¤ä½œä¸šé”™è¯¯:", error);
          showNotification("ä½œæ¥­æäº¤å¤±æ•—: " + error.message, "error");
        }
      }

      // åŠ è½½ä½œä¸šåˆ—è¡¨
      async function loadHomeworkList() {
        try {
          if (!currentRoomData || !currentRoomData.room) {
            console.error("æˆ¿é—´æ•°æ®æœªåŠ è½½");
            return;
          }

          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/homework`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("è·å–ä½œä¸šåˆ—è¡¨å¤±è´¥");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          homeworkList = result.homework;
          const homeworkSelect = document.getElementById("homeworkSelect");

          if (!homeworkSelect) {
            console.error("ä½œä¸šé€‰æ‹©å…ƒç´ æœªæ‰¾åˆ°");
            return;
          }

          // æ¸…ç©ºé€‰é¡¹
          homeworkSelect.innerHTML = '<option value="">é¸æ“‡ä½œæ¥­</option>';

          // æ·»åŠ ä½œä¸šé€‰é¡¹
          homeworkList.forEach((homework) => {
            const option = document.createElement("option");
            option.value = homework.id;
            option.textContent = `${homework.title} (æˆªæ­¢: ${new Date(
              homework.deadline
            ).toLocaleDateString()})`;
            homeworkSelect.appendChild(option);
          });
        } catch (error) {
          console.error("åŠ è½½ä½œä¸šåˆ—è¡¨é”™è¯¯:", error);
          showNotification("åŠ è½½ä½œä¸šåˆ—è¡¨å¤±è´¥", "error");
        }
      }

      function askAI() {
        const questionInput = document.getElementById("aiQuestion");
        if (!questionInput) {
          showNotification("AIé—®é¢˜è¾“å…¥æ¡†æœªæ‰¾åˆ°", "error");
          return;
        }

        const question = questionInput.value.trim();
        if (!question) {
          showNotification("è«‹è¼¸å…¥å•é¡Œ", "error");
          return;
        }

        const responseDiv = document.getElementById("aiResponse");
        if (!responseDiv) {
          showNotification("AIå“åº”åŒºåŸŸæœªæ‰¾åˆ°", "error");
          return;
        }

        responseDiv.classList.remove("hidden");
        responseDiv.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="bg-purple-100 p-2 rounded-full">
            <i class="fas fa-robot text-purple-600"></i>
          </div>
          <div class="flex-1">
            <p class="font-medium text-purple-800">AI å­¸ç¿’åŠ©æ‰‹</p>
            <p class="text-gray-700 mt-1">é€™æ˜¯ä¸€å€‹é—œæ–¼ "${question}" çš„ç¤ºç¯„å›ç­”ã€‚åœ¨å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œé€™è£¡æœƒé¡¯ç¤ºAIç”Ÿæˆçš„è©³ç´°è§£ç­”ï¼Œå¹«åŠ©æ‚¨æ›´å¥½åœ°ç†è§£èª²ç¨‹å…§å®¹ã€‚</p>
            <div class="mt-3 p-2 bg-purple-50 rounded border border-purple-100">
              <p class="text-xs text-purple-700">æç¤ºï¼šæ‚¨å¯ä»¥è©¢å•å…·é«”çš„æ¦‚å¿µè§£é‡‹ã€ç·´ç¿’é¡Œå¹«åŠ©æˆ–å­¸ç¿’å»ºè­°ã€‚</p>
            </div>
          </div>
        </div>
      `;
      }

      // èŠå¤©åŠŸèƒ½
      async function sendMessage() {
        const input = document.getElementById("messageInput");
        if (!input) {
          showNotification("æ¶ˆæ¯è¾“å…¥æ¡†æœªæ‰¾åˆ°", "error");
          return;
        }

        const message = input.value.trim();
        if (!message) return;

        try {
          // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯
          const response = await fetch(
            `/room/${currentRoomData.room.room_id}/message`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ text: message }),
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("å‘é€å¤±è´¥");
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const chatMessages = document.getElementById("chatMessages");
          if (!chatMessages) {
            showNotification("èŠå¤©æ¶ˆæ¯åŒºåŸŸæœªæ‰¾åˆ°", "error");
            return;
          }

          if (
            chatMessages.children[0] &&
            chatMessages.children[0].classList.contains("text-center")
          ) {
            chatMessages.innerHTML = "";
          }

          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
          addMessageToChat(currentUser.username, message, true);

          // æ¸…ç©ºè¾“å…¥æ¡†
          input.value = "";

          // æ»šåŠ¨åˆ°åº•éƒ¨
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("å‘é€æ¶ˆæ¯é”™è¯¯:", error);
          showNotification("å‘é€å¤±è´¥: " + error.message, "error");
        }
      }

      function addMessageToChat(user, message, isCurrentUser) {
        const chatMessages = document.getElementById("chatMessages");
        if (!chatMessages) return;

        const messageDiv = document.createElement("div");
        messageDiv.className = `flex mb-4 ${
          isCurrentUser ? "justify-end" : "justify-start"
        }`;

        if (!isCurrentUser) {
          messageDiv.innerHTML = `
          <div class="flex items-start space-x-2 max-w-xs lg:max-w-md">
            <div class="bg-gray-100 p-2 rounded-full">
              <i class="fas fa-user text-gray-600"></i>
            </div>
            <div>
              <div class="bg-gray-200 rounded-lg p-3">
                <p class="text-sm font-medium text-gray-800">${user}</p>
                <p class="text-gray-700 mt-1">${message}</p>
              </div>
              <p class="text-xs text-gray-500 mt-1">å‰›å‰›</p>
            </div>
          </div>
        `;
        } else {
          messageDiv.innerHTML = `
          <div class="bg-blue-100 rounded-lg p-3 max-w-xs lg:max-w-md">
            <p class="text-sm text-blue-800">${message}</p>
            <p class="text-xs text-blue-600 text-right mt-1">å‰›å‰›</p>
          </div>
        `;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function loadMessages(messages) {
        const chatMessages = document.getElementById("chatMessages");
        if (!chatMessages) return;

        if (messages.length === 0) {
          return;
        }

        chatMessages.innerHTML = "";

        messages.forEach((message) => {
          const isCurrentUser = message.user_id === currentUser.id;
          addMessageToChat(
            message.username || "ç”¨æˆ·",
            message.text,
            isCurrentUser
          );
        });
      }

      // æ–‡ä»¶ç¿»è¯‘åŠŸèƒ½
      async function translateText(text, targetLang) {
        // æ¨¡æ‹Ÿç¿»è¯‘åŠŸèƒ½
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve(`[${targetLang.toUpperCase()} ç¿»è­¯] ${text}`);
          }, 500);
        });
      }

      function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput || !fileInput.files || !fileInput.files.length) {
          showNotification("âš ï¸ è«‹å…ˆé¸æ“‡æª”æ¡ˆ (.txt, .docx, .pdf)", "error");
          return;
        }

        const file = fileInput.files[0];
        const ext = file.name.split(".").pop().toLowerCase();

        // æ·»åŠ æ–‡ä»¶ç±»å‹éªŒè¯
        if (!["txt", "docx", "pdf"].includes(ext)) {
          showNotification(
            "âš ï¸ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹é¸æ“‡ .txt, .docx æˆ– .pdf æª”æ¡ˆ",
            "error"
          );
          return;
        }

        try {
          if (ext === "txt") {
            readTxt(file);
          } else if (ext === "docx") {
            readDocx(file);
          } else if (ext === "pdf") {
            readPdf(file);
          }
        } catch (error) {
          console.error("æ–‡ä»¶å¤„ç†é”™è¯¯:", error);
          showNotification("âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: " + error.message, "error");
        }
      }

      function readTxt(file) {
        const reader = new FileReader();

        // æ·»åŠ å®‰å…¨çš„äº‹ä»¶å¤„ç†
        reader.onload = function (e) {
          try {
            // æ·»åŠ å®‰å…¨æ£€æŸ¥
            if (e && e.target && e.target.result) {
              processText(e.target.result);
            } else {
              showNotification("âŒ è¯»å–æ–‡æœ¬æ–‡ä»¶å¤±è´¥", "error");
            }
          } catch (error) {
            console.error("è¯»å–æ–‡æœ¬æ–‡ä»¶é”™è¯¯:", error);
            showNotification("âŒ è¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯", "error");
          }
        };

        reader.onerror = function () {
          showNotification("âŒ è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯", "error");
        };

        try {
          reader.readAsText(file, "UTF-8");
        } catch (error) {
          showNotification("âŒ æ— æ³•è¯»å–æ–‡ä»¶: " + error.message, "error");
        }
      }

      function readDocx(file) {
        const reader = new FileReader();

        reader.onload = function (event) {
          try {
            // æ·»åŠ å®‰å…¨æ£€æŸ¥
            if (!event || !event.target) {
              showNotification("âŒ è¯»å–Wordæ–‡ä»¶å¤±è´¥: æ— æ•ˆçš„äº‹ä»¶å¯¹è±¡", "error");
              return;
            }

            mammoth
              .extractRawText({ arrayBuffer: event.target.result })
              .then((result) => {
                if (result && result.value) {
                  processText(result.value);
                } else {
                  showNotification("âŒ Wordæ–‡ä»¶å†…å®¹ä¸ºç©º", "error");
                }
              })
              .catch((err) => {
                console.error("Wordæ–‡ä»¶è¯»å–é”™è¯¯:", err);
                showNotification(
                  "âŒ è®€å– Word æª”å¤±æ•—: " + err.message,
                  "error"
                );
              });
          } catch (error) {
            console.error("å¤„ç†Wordæ–‡ä»¶é”™è¯¯:", error);
            showNotification("âŒ å¤„ç†Wordæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯", "error");
          }
        };

        reader.onerror = function () {
          showNotification("âŒ è¯»å–Wordæ–‡ä»¶å¤±è´¥", "error");
        };

        try {
          reader.readAsArrayBuffer(file);
        } catch (error) {
          showNotification("âŒ æ— æ³•è¯»å–Wordæ–‡ä»¶: " + error.message, "error");
        }
      }

      async function readPdf(file) {
        const reader = new FileReader();

        reader.onload = async function (e) {
          try {
            // æ·»åŠ å®‰å…¨æ£€æŸ¥
            if (!e || !e.target) {
              throw new Error("æ— æ•ˆçš„äº‹ä»¶å¯¹è±¡");
            }

            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let textContent = "";

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              textContent +=
                content.items.map((item) => item.str).join(" ") + "\n";
            }

            processText(textContent);
          } catch (err) {
            console.error("PDFæ–‡ä»¶è¯»å–é”™è¯¯:", err);
            showNotification("âŒ è®€å– PDF æª”å¤±æ•—: " + err.message, "error");
          }
        };

        reader.onerror = function () {
          showNotification("âŒ è¯»å–PDFæ–‡ä»¶å¤±è´¥", "error");
        };

        try {
          reader.readAsArrayBuffer(file);
        } catch (error) {
          showNotification("âŒ æ— æ³•è¯»å–PDFæ–‡ä»¶: " + error.message, "error");
        }
      }

      async function processText(text) {
        const preview = document.getElementById("preview");

        // æ·»åŠ å®‰å…¨æ£€æŸ¥
        if (!preview) {
          console.error("é¢„è§ˆå…ƒç´ æœªæ‰¾åˆ°");
          showNotification("âŒ é¢„è§ˆåŒºåŸŸæœªæ‰¾åˆ°", "error");
          return;
        }

        preview.innerHTML =
          "<div class='text-center py-4'><div class='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto'></div><p class='text-gray-500 mt-2'>æ­£åœ¨è™•ç†æ–‡ä»¶...</p></div>";

        if (!text) {
          preview.innerHTML =
            "<p class='text-red-500 text-center py-4'>âš ï¸ æª”æ¡ˆæ²’æœ‰å…§å®¹</p>";
          return;
        }

        const langTo = document.getElementById("langTo");
        if (!langTo) {
          showNotification("âŒ è¯­è¨€é€‰æ‹©å…ƒç´ æœªæ‰¾åˆ°", "error");
          return;
        }

        const targetLang = langTo.value;
        const lines = text.split("\n").filter((line) => line.trim() !== "");
        let processedLines = 0;

        preview.innerHTML = "";

        // é™åˆ¶å¤„ç†çš„è¡Œæ•°ï¼Œé¿å…æ€§èƒ½é—®é¢˜
        const maxLines = Math.min(lines.length, 100);

        for (let i = 0; i < maxLines; i++) {
          const line = lines[i];
          if (line.trim() !== "") {
            try {
              const translated = await translateText(line, targetLang);
              const div = document.createElement("div");
              div.className = "p-3 border-b border-gray-200";
              div.innerHTML = `
              <div class="mb-2">
                <span class="text-xs text-gray-500">åŸæ–‡:</span>
                <p class="text-gray-800">${line}</p>
              </div>
              <div>
                <span class="text-xs text-gray-500">ç¿»è­¯:</span>
                <p class="text-blue-700">${translated}</p>
              </div>
            `;
              preview.appendChild(div);
              processedLines++;

              // æ›´æ–°è¿›åº¦
              if (processedLines % 5 === 0) {
                preview.scrollTop = preview.scrollHeight;
              }
            } catch (error) {
              console.error("ç¿»è¯‘é”™è¯¯:", error);
              // ç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
            }
          }
        }

        if (processedLines === 0) {
          preview.innerHTML =
            "<p class='text-red-500 text-center py-4'>âš ï¸ æª”æ¡ˆæ²’æœ‰å¯è™•ç†çš„å…§å®¹</p>";
        } else {
          showNotification(`âœ… å·²æˆåŠŸè™•ç† ${processedLines} è¡Œæ–‡æœ¬`, "success");

          // å¦‚æœæœ‰é™åˆ¶è¡Œæ•°ï¼Œæ˜¾ç¤ºæç¤º
          if (lines.length > maxLines) {
            const warningDiv = document.createElement("div");
            warningDiv.className =
              "p-3 bg-yellow-50 border border-yellow-200 rounded-lg mt-4";
            warningDiv.innerHTML = `
            <p class="text-yellow-700 text-sm">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              æ–‡ä»¶è¾ƒå¤§ï¼Œåªæ˜¾ç¤ºäº†å‰ ${maxLines} è¡Œå†…å®¹
            </p>
          `;
            preview.appendChild(warningDiv);
          }
        }
      }

      function exportFile() {
        const preview = document.getElementById("preview");
        if (!preview) {
          showNotification("âŒ é¢„è§ˆåŒºåŸŸæœªæ‰¾åˆ°", "error");
          return;
        }

        const content = preview.innerText;
        if (!content.trim()) {
          showNotification("âš ï¸ æ²’æœ‰ç¿»è­¯çµæœå¯å°å‡º", "error");
          return;
        }

        try {
          const blob = new Blob([content], {
            type: "text/plain;charset=utf-8",
          });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "translation.txt";
          link.click();
          showNotification("âœ… æ–‡ä»¶å·²å°å‡º", "success");
        } catch (error) {
          console.error("å¯¼å‡ºæ–‡ä»¶é”™è¯¯:", error);
          showNotification("âŒ å¯¼å‡ºæ–‡ä»¶å¤±è´¥: " + error.message, "error");
        }
      }

      function loadCourseMaterials(materials) {
        const materialsList = document.getElementById("materialsList");
        if (!materialsList) {
          console.error("æ•™æåˆ—è¡¨å…ƒç´ æœªæ‰¾åˆ°");
          return;
        }

        materialsList.innerHTML = "";

        if (!materials || materials.length === 0) {
          materialsList.innerHTML = `
          <li class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-4">
              <i class="fas fa-folder-open"></i>
            </div>
            <p>æš«ç„¡æ•™æ</p>
            <p class="text-sm mt-1">è€å¸«æœƒåœ¨æ­¤è™•ä¸Šå‚³èª²ç¨‹æ•™æ</p>
          </li>
        `;
          return;
        }

        materials.forEach((material) => {
          const li = document.createElement("li");
          li.className =
            "material-card bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center";
          li.innerHTML = `
          <div class="flex items-center">
            <div class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">
              <i class="fas fa-file-${
                material.type === "è¦–é »"
                  ? "video"
                  : material.type === "ç·´ç¿’é¡Œ"
                  ? "word"
                  : "pdf"
              }"></i>
            </div>
            <div>
              <h4 class="font-medium text-gray-800">${material.title}</h4>
              <p class="text-sm text-gray-500">${material.type} â€¢ ${new Date(
            material.created_at
          ).toLocaleDateString()}</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="previewMaterial('${material.url}', '${
            material.type
          }')" 
                    class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors">
              <i class="fas fa-eye"></i>
            </button>
            <a href="${material.url}" download 
               class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors">
              <i class="fas fa-download"></i>
            </a>
          </div>
        `;
          materialsList.appendChild(li);
        });
      }

      function previewMaterial(url, type) {
        if (!url) {
          showNotification("âŒ æ–‡ä»¶éˆæ¥ç„¡æ•ˆ", "error");
          return;
        }

        // åœ¨æ–°çª—å£ä¸­æ‰“é–‹æ–‡ä»¶é€²è¡Œé è¦½
        window.open(url, "_blank");

        showNotification(`æ­£åœ¨é è¦½: ${type} æ–‡ä»¶`, "info");
      }

      function showNotification(message, type) {
        const notificationArea = document.getElementById("notificationArea");
        if (!notificationArea) {
          console.error("é€šçŸ¥åŒºåŸŸæœªæ‰¾åˆ°");
          return;
        }

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);

        // æ˜¾ç¤ºé€šçŸ¥
        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        // éšè—é€šçŸ¥
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (notificationArea.contains(notification)) {
              notificationArea.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      window.addEventListener("load", function () {
        fetch("/check-auth", {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache, no-store, must-revalidate",
            Pragma: "no-cache",
            Expires: "0",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              // æœªç™»å…¥ï¼Œç«‹å³é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
              document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
              <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                <h1 style="color: #ef4444; margin-bottom: 1rem;">âš ï¸ æœªæˆæ¬Šè¨ªå•</h1>
                <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">${JSON.stringify(
                  data,
                  null,
                  2
                )}</pre>
                <p style="margin-top: 1rem; color: #6b7280;">
                  <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                </p>
              </div>
            </div>
          `;
              return;
            }
            // æ¬Šé™é©—è­‰é€šéï¼Œåˆå§‹åŒ–å­¸ç”Ÿæˆ¿é–“é é¢
            initStudentRoom();
          })
          .catch((error) => {
            console.error("èªè­‰æª¢æŸ¥éŒ¯èª¤:", error);
            document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
            <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
              <h1 style="color: #ef4444; margin-bottom: 1rem;">âŒ é€£æ¥éŒ¯èª¤</h1>
              <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">{"success": false, "message": "è«‹å…ˆç™»å…¥ç³»çµ±"}</pre>
              <p style="margin-top: 1rem; color: #6b7280;">
                <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
              </p>
            </div>
          </div>
        `;
          });
      });

      // é˜²æ­¢ä½¿ç”¨ç€è¦½å™¨è¿”å›æŒ‰éˆ•
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      });

      // åˆå§‹åŒ–å­¸ç”Ÿæˆ¿é–“é é¢çš„å‡½æ•¸
      function initStudentRoom() {
        console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
        init();
      }

      // åˆå§‹åŒ–é¡µé¢
      document.addEventListener("DOMContentLoaded", function () {
        // DOMContentLoaded æ™‚ä¸ç›´æ¥åˆå§‹åŒ–ï¼Œç­‰å¾… load äº‹ä»¶çš„æ¬Šé™æª¢æŸ¥
        console.log("ğŸ“„ DOM å…§å®¹å·²è¼‰å…¥ï¼Œç­‰å¾…æ¬Šé™é©—è­‰...");
      });
    </script>
  </body>
</html>
