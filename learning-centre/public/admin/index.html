<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <title>SmartEdu ç®¡ç†å“¡å°ˆå€</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* === SmartEdu å…¨ç«™å…±ç”¨æ¨£å¼ === */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Noto Sans HK", "Microsoft JhengHei", -apple-system,
          BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #2d3748;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: #2d3748;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      h2 {
        font-size: 2rem;
        color: #4a5568;
      }

      h3 {
        font-size: 1.5rem;
        color: #4a5568;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        gap: 0.5rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .btn-secondary:hover {
        background: #cbd5e0;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: linear-gradient(135deg, #fc8181, #f56565);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(245, 101, 101, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #68d391, #48bb78);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #4a5568;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .table-container {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
      }

      .table td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
      }

      .table tr:hover {
        background: #f7fafc;
      }

      .table tr:last-child td {
        border-bottom: none;
      }

      .navbar {
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 1rem 2rem;
        border-radius: 0 0 20px 20px;
        margin-bottom: 2rem;
      }

      .sidebar {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        height: fit-content;
      }

      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .sidebar-item {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        border: none;
        background: transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        color: #4a5568;
        text-decoration: none;
        gap: 0.75rem;
      }

      .sidebar-item:hover {
        background: #f7fafc;
        transform: translateX(5px);
      }

      .sidebar-item.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #718096;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .progress-bar {
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        height: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 10px;
        transition: width 0.5s ease;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background: linear-gradient(135deg, #68d391, #48bb78);
      }

      .notification.error {
        background: linear-gradient(135deg, #fc8181, #f56565);
      }

      .notification.warning {
        background: linear-gradient(135deg, #f6e05e, #ecc94b);
      }

      .notification.info {
        background: linear-gradient(135deg, #667eea, #764ba2);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        margin-top: 1rem;
        color: #4a5568;
        font-weight: 600;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
      .smooth-transition {
        transition: all 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-3px);
      }

      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        .card {
          padding: 1.5rem;
        }
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .navbar {
          padding: 1rem;
        }
        h1 {
          font-size: 2rem;
        }
        h2 {
          font-size: 1.5rem;
        }
      }
    </style>
    <script>
      // é˜²æ­¢é é¢è¢«ç·©å­˜
      window.onpageshow = function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      };

      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ¬Šé™
      function checkAuth() {
        fetch("/check-auth", {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              showNotification("è«‹å…ˆç™»å…¥ï¼", "warning");
              setTimeout(() => {
                window.location.href = "/index.html";
              }, 1500);
              return;
            }
            if (data.user.role !== "admin") {
              showNotification("æ¬Šé™ä¸è¶³ï¼åªæœ‰ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢ã€‚", "error");
              setTimeout(() => {
                window.location.href = "/index.html";
              }, 1500);
              return;
            }
            updateUserDisplay(data.user.username, data.user.role);
          })
          .catch((error) => {
            console.error("æª¢æŸ¥ç™»å…¥ç‹€æ…‹æ™‚å‡ºéŒ¯:", error);
            showNotification("é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥", "error");
            setTimeout(() => {
              window.location.href = "/index.html";
            }, 1500);
          });
      }

      // æ›´æ–°ç”¨æˆ¶é¡¯ç¤º
      function updateUserDisplay(username, role) {
        const userElement = document.querySelector(
          ".flex.items-center.space-x-4 span"
        );
        if (userElement) {
          let emoji = "ğŸ‘¤";
          if (role === "student") emoji = "ğŸ‘©ğŸ»â€ğŸ“";
          else if (role === "teacher") emoji = "ğŸ‘¨ğŸ»â€ğŸ«";
          else if (role === "admin") emoji = "ğŸ§‘â€ğŸ’¼";
          userElement.textContent = emoji + " " + username + " | ç®¡ç†å“¡";
        }
      }

      // ç™»å‡ºåŠŸèƒ½
      function logout() {
        showConfirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ", function () {
          fetch("/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showNotification("å·²æˆåŠŸç™»å‡º", "success");
                // æ¸…é™¤æœƒè©±å„²å­˜ä¸¦é‡å®šå‘
                sessionStorage.clear();
                localStorage.clear();
                // ä½¿ç”¨ replace é˜²æ­¢è¿”å›
                setTimeout(() => {
                  window.location.replace("/index.html");
                }, 1000);
              } else {
                showNotification("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
              }
            })
            .catch((error) => {
              console.error("ç™»å‡ºéŒ¯èª¤:", error);
              window.location.replace("/index.html");
            });
        });
      }

      // é é¢åŠ è¼‰æ™‚ç«‹å³æª¢æŸ¥
      checkAuth();
      // å®šæœŸæª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼ˆæ¯30ç§’ï¼‰
      setInterval(checkAuth, 30000);
    </script>
  </head>
  <body class="bg-gray-50 font-sans text-gray-800">
    <!-- Navbar -->
    <header class="navbar">
      <h1 class="text-xl font-bold tracking-wide">SmartEdu ç®¡ç†å“¡å°ˆå€</h1>
      <div class="flex items-center space-x-4">
        <span>ğŸ§‘â€ğŸ’¼ ç®¡ç†å“¡</span>
        <button onclick="logout()" class="btn btn-danger">ç™»å‡º</button>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="container">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Sidebar -->
        <aside class="sidebar">
          <nav class="sidebar-nav">
            <button
              onclick="showSection('user-management')"
              class="sidebar-item active"
            >
              <span>ğŸ‘¥</span> ç”¨æˆ¶ç®¡ç†
            </button>
            <button
              onclick="showSection('course-management')"
              class="sidebar-item"
            >
              <span>ğŸ“š</span> èª²ç¨‹ç®¡ç†
            </button>
            <button
              onclick="showSection('system-monitoring')"
              class="sidebar-item"
            >
              <span>ğŸ“Š</span> ç³»çµ±ç›£æ¸¬
            </button>
          </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
          <!-- ç”¨æˆ¶ç®¡ç†å€å¡Š -->
          <div id="user-management" class="section card">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">
              <span class="mr-2">ğŸ‘¥</span> ç”¨æˆ¶ç®¡ç†
            </h2>

            <!-- ç”¨æˆ¶çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="teacherCount">0</div>
                <div class="stat-label">æ•™å¸«äººæ•¸</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="studentCount">0</div>
                <div class="stat-label">å­¸ç”Ÿäººæ•¸</div>
              </div>
            </div>

            <!-- æœå°‹åŠŸèƒ½ -->
            <div class="card mb-6">
              <h3
                class="text-lg font-bold text-blue-800 mb-4 flex items-center"
              >
                <span class="mr-2">ğŸ”</span> æœå°‹ç”¨æˆ¶
              </h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <!-- é—œéµå­—æœå°‹ -->
                <div class="md:col-span-2">
                  <input
                    type="text"
                    id="searchKeyword"
                    placeholder="æœå°‹ç”¨æˆ¶åã€ID..."
                    class="form-input"
                  />
                </div>

                <!-- è§’è‰²ç¯©é¸ -->
                <div>
                  <select id="searchRole" class="form-select">
                    <option value="">æ‰€æœ‰è§’è‰²</option>
                    <option value="student">å­¸ç”Ÿ</option>
                    <option value="teacher">æ•™å¸«</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                  </select>
                </div>

                <!-- æœå°‹æŒ‰éˆ• -->
                <div class="flex space-x-2">
                  <button id="searchBtn" class="btn btn-primary flex-1">
                    <span>ğŸ”</span> æœå°‹
                  </button>
                  <button
                    id="clearSearch"
                    class="btn btn-secondary"
                    title="æ¸…é™¤æœå°‹"
                  >
                    <span>ğŸ—‘ï¸</span>
                  </button>
                </div>
              </div>

              <!-- æœå°‹çµæœçµ±è¨ˆ -->
              <div
                id="searchStats"
                class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <span class="text-blue-800 font-semibold">æœå°‹çµæœï¼š</span>
                    <span id="resultCount" class="text-blue-600">0</span> å€‹ç”¨æˆ¶
                    <span
                      id="searchCriteria"
                      class="text-blue-600 text-sm ml-2"
                    ></span>
                  </div>
                  <button
                    id="showAllUsers"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                  >
                    é¡¯ç¤ºæ‰€æœ‰ç”¨æˆ¶
                  </button>
                </div>
              </div>
            </div>

            <div class="card">
              <!-- Add User Form -->
              <form
                id="addUserForm"
                class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"
              >
                <input
                  type="text"
                  id="username"
                  placeholder="å¸³è™Ÿåç¨±"
                  class="form-input"
                  required
                />
                <input
                  type="password"
                  id="password"
                  placeholder="å¯†ç¢¼"
                  class="form-input"
                  required
                />
                <select id="role" class="form-select">
                  <option value="student">å­¸ç”Ÿ</option>
                  <option value="teacher">æ•™å¸«</option>
                  <option value="admin">ç®¡ç†å“¡</option>
                </select>
                <button type="submit" class="btn btn-primary">
                  <span>â•</span> æ–°å¢ç”¨æˆ¶
                </button>
              </form>

              <!-- User Table -->
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>å¸³è™Ÿ</th>
                      <th>è§’è‰²</th>
                      <th class="w-48">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="userList"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- èª²ç¨‹ç®¡ç†å€å¡Š -->
          <div id="course-management" class="section card hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">
              <span class="mr-2">ğŸ“š</span> èª²ç¨‹ç®¡ç†
            </h2>

            <!-- èª²ç¨‹çµ±è¨ˆ -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalCourses">0</div>
                <div class="stat-label">ç¸½èª²ç¨‹æ•¸</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="activeCourses">0</div>
                <div class="stat-label">æ´»èºèª²ç¨‹</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalTeachers">0</div>
                <div class="stat-label">æ•™å¸«äººæ•¸</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalEnrollments">0</div>
                <div class="stat-label">ç¸½é¸èª²æ•¸</div>
              </div>
            </div>

            <div class="card">
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>èª²ç¨‹ID</th>
                      <th>èª²ç¨‹åç¨±</th>
                      <th>æ•™å¸«</th>
                      <th>å­¸ç”Ÿäººæ•¸</th>
                      <th>å‰µå»ºæ™‚é–“</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="courseList"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ç³»çµ±ç›£æ¸¬å€å¡Š -->
          <div id="system-monitoring" class="section card hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">
              <span class="mr-2">ğŸ“Š</span> ç³»çµ±ç›£æ¸¬
            </h2>

            <!-- ç³»çµ±ç‹€æ…‹å¡ç‰‡ -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-lg font-bold text-green-800">
                      ä¼ºæœå™¨ç‹€æ…‹
                    </div>
                    <div class="text-green-600 text-sm" id="serverStatus">
                      é‹è¡Œä¸­
                    </div>
                  </div>
                  <div class="text-2xl">ğŸŸ¢</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-lg font-bold text-blue-800">
                      è³‡æ–™åº«ç‹€æ…‹
                    </div>
                    <div class="text-blue-600 text-sm" id="databaseStatus">
                      å·²é€£æ¥
                    </div>
                  </div>
                  <div class="text-2xl">ğŸ”µ</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-lg font-bold text-purple-800">
                      é‹è¡Œæ™‚é–“
                    </div>
                    <div class="text-purple-600 text-sm" id="uptime">
                      0 å¤© 0 æ™‚ 0 åˆ†
                    </div>
                  </div>
                  <div class="text-2xl">â±ï¸</div>
                </div>
              </div>
            </div>

            <!-- ç³»çµ±è³‡è¨Š -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="card">
                <h3 class="text-lg font-bold text-blue-800 mb-4">ç³»çµ±è³‡æº</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span>è¨˜æ†¶é«”ä½¿ç”¨</span>
                      <span id="memoryUsage">0 MB</span>
                    </div>
                    <div class="progress-bar">
                      <div
                        id="memoryBar"
                        class="progress-fill"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span>CPU ä½¿ç”¨ç‡</span>
                      <span id="cpuUsage">0%</span>
                    </div>
                    <div class="progress-bar">
                      <div
                        id="cpuBar"
                        class="progress-fill"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3 class="text-lg font-bold text-blue-800 mb-4">å³æ™‚æ•¸æ“š</h3>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span>åœ¨ç·šç”¨æˆ¶</span>
                    <span id="onlineUsers">0</span>
                  </div>
                  <div class="flex justify-between">
                    <span>æ´»èºèª²ç¨‹</span>
                    <span id="activeCoursesCount">0</span>
                  </div>
                  <div class="flex justify-between">
                    <span>ä»Šæ—¥æ¶ˆæ¯</span>
                    <span id="todayMessages">0</span>
                  </div>
                  <div class="flex justify-between">
                    <span>ç³»çµ±ç‰ˆæœ¬</span>
                    <span id="systemVersion">SmartEdu v1.0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal for Edit User -->
    <div
      id="editModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-lg p-6 w-96 smooth-transition">
        <h3 class="text-xl font-semibold mb-4 text-blue-700 flex items-center">
          <span class="mr-2">âœï¸</span> ç·¨è¼¯ç”¨æˆ¶
        </h3>
        <input type="hidden" id="editUserId" />
        <div class="space-y-3">
          <input
            type="text"
            id="editUsername"
            class="form-input"
            placeholder="å¸³è™Ÿåç¨±"
            required
          />
          <input
            type="password"
            id="editPassword"
            class="form-input"
            placeholder="å¯†ç¢¼ (å¦‚ä¸æ”¹å¯ç•™ç©º)"
          />
          <select id="editRole" class="form-select">
            <option value="student">å­¸ç”Ÿ</option>
            <option value="teacher">æ•™å¸«</option>
            <option value="admin">ç®¡ç†å“¡</option>
          </select>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button id="cancelEdit" class="btn btn-secondary">å–æ¶ˆ</button>
          <button id="saveEdit" class="btn btn-success">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- åŠ è¼‰å‹•ç•« -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer"></div>

    <script>
      const apiUrl = window.location.origin;

      // === æœå°‹åŠŸèƒ½è®Šæ•¸ ===
      let currentSearch = {
        keyword: "",
        role: "",
        page: 1,
        limit: 50,
        isSearching: false,
      };

      // === é€šç”¨å·¥å…·å‡½æ•¸ ===
      function showLoading(text = "è¼‰å…¥ä¸­...") {
        const overlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        if (overlay && loadingText) {
          loadingText.textContent = text;
          overlay.classList.remove("hidden");
        }
      }

      function hideLoading() {
        const overlay = document.getElementById("loadingOverlay");
        if (overlay) {
          overlay.classList.add("hidden");
        }
      }

      function showNotification(message, type = "info", duration = 3000) {
        const container = document.getElementById("notificationContainer");
        if (!container) return;

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        let icon = "â„¹ï¸";
        switch (type) {
          case "success":
            icon = "âœ…";
            break;
          case "error":
            icon = "âŒ";
            break;
          case "warning":
            icon = "âš ï¸";
            break;
          case "info":
            icon = "â„¹ï¸";
            break;
        }

        notification.innerHTML = `
        <div class="flex items-center">
          <span class="text-lg mr-2">${icon}</span>
          <span>${message}</span>
        </div>
      `;

        container.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (container.contains(notification)) {
              container.removeChild(notification);
            }
          }, 300);
        }, duration);
      }

      function showConfirm(message, confirmCallback, cancelCallback = null) {
        if (confirm(message)) {
          confirmCallback();
        } else if (cancelCallback) {
          cancelCallback();
        }
      }

      // === æœå°‹åŠŸèƒ½ ===

      // === åˆå§‹åŒ–æœå°‹åŠŸèƒ½ ===
      function initSearch() {
        const searchInput = document.getElementById("searchKeyword");
        const roleFilter = document.getElementById("searchRole");
        const searchBtn = document.getElementById("searchBtn");
        const clearBtn = document.getElementById("clearSearch");
        const showAllBtn = document.getElementById("showAllUsers");

        // å³æ™‚æœå°‹ï¼ˆé˜²æŠ–ï¼‰
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentSearch.keyword = e.target.value;
            currentSearch.page = 1;
            if (e.target.value.trim() !== "" || currentSearch.role !== "") {
              performSearch();
            }
          }, 800);
        });

        // è§’è‰²ç¯©é¸
        roleFilter.addEventListener("change", (e) => {
          currentSearch.role = e.target.value;
          currentSearch.page = 1;
          if (currentSearch.keyword !== "" || e.target.value !== "") {
            performSearch();
          }
        });

        // æœå°‹æŒ‰éˆ•
        searchBtn.addEventListener("click", performSearch);

        // æ¸…é™¤æœå°‹
        clearBtn.addEventListener("click", () => {
          searchInput.value = "";
          roleFilter.value = "";
          currentSearch.keyword = "";
          currentSearch.role = "";
          currentSearch.page = 1;
          currentSearch.isSearching = false;

          hideSearchStats();
          loadUsers(); // é‡æ–°è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
        });

        // é¡¯ç¤ºæ‰€æœ‰ç”¨æˆ¶
        if (showAllBtn) {
          showAllBtn.addEventListener("click", () => {
            searchInput.value = "";
            roleFilter.value = "";
            currentSearch.keyword = "";
            currentSearch.role = "";
            currentSearch.page = 1;
            currentSearch.isSearching = false;

            hideSearchStats();
            loadUsers(); // é‡æ–°è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
          });
        }

        // Enter éµæœå°‹
        searchInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            performSearch();
          }
        });
      }

      // === åŸ·è¡Œæœå°‹ ===
      async function performSearch() {
        if (!currentSearch.keyword.trim() && !currentSearch.role) {
          // å¦‚æœæ²’æœ‰æœå°‹æ¢ä»¶ï¼Œé¡¯ç¤ºæ‰€æœ‰ç”¨æˆ¶
          currentSearch.isSearching = false;
          hideSearchStats();
          loadUsers();
          return;
        }

        currentSearch.isSearching = true;
        showLoading("æœå°‹ç”¨æˆ¶ä¸­...");

        try {
          const params = new URLSearchParams();
          if (currentSearch.keyword)
            params.append("keyword", currentSearch.keyword);
          if (currentSearch.role) params.append("role", currentSearch.role);
          params.append("page", currentSearch.page);
          params.append("limit", currentSearch.limit);

          console.log(`ğŸ” ç™¼é€æœå°‹è«‹æ±‚: /admin/users/search?${params}`);

          const response = await fetch(
            `${apiUrl}/admin/users/search?${params}`
          );

          if (!response.ok) {
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || "æœå°‹å¤±æ•—");
          }

          console.log(`âœ… æœå°‹æˆåŠŸï¼Œæ‰¾åˆ° ${result.total} å€‹ç”¨æˆ¶`);

          // é¡¯ç¤ºæœå°‹çµæœ
          displayUsers(result.users);
          updateSearchStats(result.total, result.searchParams);
        } catch (error) {
          console.error("âŒ æœå°‹éŒ¯èª¤:", error);
          showNotification("æœå°‹å¤±æ•—: " + error.message, "error");

          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          const tbody = document.getElementById("userList");
          tbody.innerHTML = `
      <tr>
        <td colspan="4" class="border px-3 py-2 text-center text-red-500">
          æœå°‹å¤±æ•—: ${error.message}
        </td>
      </tr>
    `;
        } finally {
          hideLoading();
        }
      }

      // === æ›´æ–°æœå°‹çµ±è¨ˆ ===
      function updateSearchStats(total, searchParams) {
        const statsElement = document.getElementById("searchStats");
        const countElement = document.getElementById("resultCount");
        const criteriaElement = document.getElementById("searchCriteria");

        if (total >= 0) {
          statsElement.classList.remove("hidden");
          countElement.textContent = total;

          // é¡¯ç¤ºæœå°‹æ¢ä»¶
          let criteriaText = "";
          if (searchParams.keyword) {
            criteriaText += `é—œéµå­—: "${searchParams.keyword}"`;
          }
          if (searchParams.role) {
            if (criteriaText) criteriaText += "ï¼Œ";
            const roleDisplay =
              searchParams.role === "teacher"
                ? "æ•™å¸«"
                : searchParams.role === "admin"
                ? "ç®¡ç†å“¡"
                : "å­¸ç”Ÿ";
            criteriaText += `è§’è‰²: ${roleDisplay}`;
          }

          criteriaElement.textContent = criteriaText ? `(${criteriaText})` : "";
        }
      }

      // === éš±è—æœå°‹çµ±è¨ˆ ===
      function hideSearchStats() {
        const statsElement = document.getElementById("searchStats");
        statsElement.classList.add("hidden");
      }

      // === é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨çš„é€šç”¨å‡½æ•¸ ===
      function displayUsers(users) {
        const tbody = document.getElementById("userList");
        tbody.innerHTML = "";

        if (users.length === 0) {
          console.log("â„¹ï¸ æ²’æœ‰ç”¨æˆ¶æ•¸æ“š");
          tbody.innerHTML = `
      <tr>
        <td colspan="4" class="border px-3 py-2 text-center text-gray-500">
          æš«ç„¡ç”¨æˆ¶æ•¸æ“š
        </td>
      </tr>
    `;
        } else {
          console.log(`ğŸ“Š é–‹å§‹æ¸²æŸ“ ${users.length} å€‹ç”¨æˆ¶`);
          users.forEach((u) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 smooth-transition";

            const roleClass =
              u.role === "teacher" ? "text-blue-600 font-semibold" : "";
            const roleDisplay =
              u.role === "teacher"
                ? "ğŸ‘¨ğŸ»â€ğŸ« æ•™å¸«"
                : u.role === "admin"
                ? "ğŸ§‘â€ğŸ’¼ ç®¡ç†å“¡"
                : "ğŸ‘©ğŸ»â€ğŸ“ å­¸ç”Ÿ";

            tr.innerHTML = `
        <td class="text-center">${u.id}</td>
        <td>${u.username}</td>
        <td class="text-center ${roleClass}">${roleDisplay}</td>
        <td class="text-center">
          <button onclick="openEditModal(${u.id}, '${u.username}', '${u.role}')" 
                  class="text-blue-600 hover:underline hover:text-blue-800 smooth-transition mr-2">ç·¨è¼¯</button>
          <button onclick="deleteUser(${u.id})" 
                  class="text-red-600 hover:underline hover:text-red-800 smooth-transition">åˆªé™¤</button>
        </td>
      `;
            tbody.appendChild(tr);
          });
        }
      }

      // åˆ‡æ›å€å¡Šé¡¯ç¤º
      function showSection(id) {
        console.log(`ğŸ”„ åˆ‡æ›åˆ°å€å¡Š: ${id}`);

        // éš±è—æ‰€æœ‰å€å¡Š
        document
          .querySelectorAll(".section")
          .forEach((el) => el.classList.add("hidden"));

        // é¡¯ç¤ºç›®æ¨™å€å¡Š
        document.getElementById(id).classList.remove("hidden");

        // æ ¹æ“šåˆ‡æ›çš„å€å¡Šè¼‰å…¥å°æ‡‰æ•¸æ“š
        if (id === "user-management") {
          console.log("ğŸ“‹ è¼‰å…¥ç”¨æˆ¶ç®¡ç†æ•¸æ“š");
          setTimeout(() => {
            loadUsers();
          }, 100);
        } else if (id === "course-management") {
          console.log("ğŸ“š è¼‰å…¥èª²ç¨‹ç®¡ç†æ•¸æ“š");
          setTimeout(() => {
            loadCourses();
          }, 100);
        } else if (id === "system-monitoring") {
          console.log("ğŸ“Š è¼‰å…¥ç³»çµ±ç›£æ¸¬æ•¸æ“š");
          setTimeout(() => {
            loadSystemStatus();
          }, 100);
        }

        // æ›´æ–°å´é‚Šæ¬„æ¿€æ´»ç‹€æ…‹
        document.querySelectorAll(".sidebar-item").forEach((item) => {
          item.classList.remove("active");
        });

        // æ‰¾åˆ°å°æ‡‰çš„å´é‚Šæ¬„æŒ‰éˆ•ä¸¦æ¿€æ´»
        const activeButton = Array.from(
          document.querySelectorAll(".sidebar-item")
        ).find((item) => {
          const onclickAttr = item.getAttribute("onclick");
          return onclickAttr && onclickAttr.includes(`'${id}'`);
        });

        if (activeButton) {
          activeButton.classList.add("active");
        }
      }

      // === è®€å–æ‰€æœ‰ç”¨æˆ¶ ===
      async function loadUsers() {
        // å¦‚æœæ­£åœ¨æœå°‹ï¼Œä¸åŸ·è¡Œæ™®é€šè¼‰å…¥
        if (currentSearch.isSearching) {
          return;
        }

        showLoading("è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ä¸­...");
        try {
          console.log("ğŸ” é–‹å§‹è¼‰å…¥ç”¨æˆ¶æ•¸æ“š...");

          const res = await fetch(`${apiUrl}/users`);
          console.log("ğŸ“¡ API éŸ¿æ‡‰ç‹€æ…‹:", res.status, res.statusText);

          if (!res.ok) {
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${res.status}`);
          }

          const users = await res.json();
          console.log("âœ… ç²å–åˆ°çš„ç”¨æˆ¶æ•¸æ“š:", users);

          displayUsers(users);
          updateUserStats(users);

          showNotification(`æˆåŠŸè¼‰å…¥ ${users.length} å€‹ç”¨æˆ¶`, "success");
        } catch (error) {
          console.error("âŒ è¼‰å…¥ç”¨æˆ¶æ™‚å‡ºéŒ¯:", error);
          showNotification("è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—: " + error.message, "error");

          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          const tbody = document.getElementById("userList");
          tbody.innerHTML = `
      <tr>
        <td colspan="4" class="border px-3 py-2 text-center text-red-500">
          è¼‰å…¥ç”¨æˆ¶å¤±æ•—: ${error.message}
        </td>
      </tr>
    `;
        } finally {
          hideLoading();
        }
      }

      // === èª²ç¨‹ç®¡ç†åŠŸèƒ½ ===
      async function loadCourses() {
        showLoading("è¼‰å…¥èª²ç¨‹åˆ—è¡¨ä¸­...");
        try {
          console.log("ğŸ” é–‹å§‹è¼‰å…¥èª²ç¨‹æ•¸æ“š...");

          const res = await fetch(`${apiUrl}/admin/courses`);
          console.log("ğŸ“¡ èª²ç¨‹ API éŸ¿æ‡‰ç‹€æ…‹:", res.status, res.statusText);

          if (!res.ok) {
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${res.status}`);
          }

          const result = await res.json();
          console.log("âœ… ç²å–åˆ°çš„èª²ç¨‹æ•¸æ“š:", result);

          // è™•ç†å…©ç¨®å¯èƒ½çš„å›å‚³æ ¼å¼ï¼šé™£åˆ—æˆ–åŒ…å« success çš„ç‰©ä»¶
          let courses;
          if (Array.isArray(result)) {
            // ç›´æ¥å›å‚³é™£åˆ—æ ¼å¼
            courses = result;
          } else if (result.success && result.courses) {
            // åŒ…å« success çš„ç‰©ä»¶æ ¼å¼
            courses = result.courses;
          } else if (!result.success) {
            throw new Error(result.message || "ç²å–èª²ç¨‹æ•¸æ“šå¤±æ•—");
          } else {
            throw new Error("æœªçŸ¥çš„å›å‚³æ ¼å¼");
          }

          const tbody = document.getElementById("courseList");
          tbody.innerHTML = "";

          // æ›´æ–°çµ±è¨ˆ
          document.getElementById("totalCourses").textContent = courses.length;
          document.getElementById("activeCourses").textContent = courses.length;

          // è¨ˆç®—æ•™å¸«æ•¸å’Œé¸èª²æ•¸
          const teacherSet = new Set();
          let totalEnrollments = 0;

          courses.forEach((course) => {
            teacherSet.add(course.teacher_name);
            totalEnrollments += course.student_count || 0;
          });

          document.getElementById("totalTeachers").textContent =
            teacherSet.size;
          document.getElementById("totalEnrollments").textContent =
            totalEnrollments;

          if (courses.length === 0) {
            tbody.innerHTML = `
        <tr>
          <td colspan="6" class="border px-3 py-2 text-center text-gray-500">
            æš«ç„¡èª²ç¨‹æ•¸æ“š
          </td>
        </tr>
      `;
          } else {
            courses.forEach((course) => {
              const tr = document.createElement("tr");
              tr.className = "hover:bg-gray-50 smooth-transition";
              tr.innerHTML = `
          <td class="text-center">${course.id}</td>
          <td>${course.name}</td>
          <td>${course.teacher_name}</td>
          <td class="text-center">${course.student_count || 0}</td>
          <td class="text-center">${new Date(
            course.created_at
          ).toLocaleDateString()}</td>
          <td class="text-center">
            <button onclick="viewCourseDetails(${
              course.id
            })" class="text-blue-600 hover:underline hover:text-blue-800 smooth-transition mr-2">æŸ¥çœ‹</button>
            <button onclick="deleteCourse(${
              course.id
            })" class="text-red-600 hover:underline hover:text-red-800 smooth-transition">åˆªé™¤</button>
          </td>
        `;
              tbody.appendChild(tr);
            });
          }

          showNotification(`æˆåŠŸè¼‰å…¥ ${courses.length} å€‹èª²ç¨‹`, "success");
        } catch (error) {
          console.error("âŒ è¼‰å…¥èª²ç¨‹æ™‚å‡ºéŒ¯:", error);
          showNotification("è¼‰å…¥èª²ç¨‹åˆ—è¡¨å¤±æ•—: " + error.message, "error");

          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          const tbody = document.getElementById("courseList");
          tbody.innerHTML = `
      <tr>
        <td colspan="6" class="border px-3 py-2 text-center text-red-500">
          è¼‰å…¥èª²ç¨‹å¤±æ•—: ${error.message}
        </td>
      </tr>
    `;
        } finally {
          hideLoading();
        }
      }

      // æ›´æ–°ç”¨æˆ¶çµ±è¨ˆ
      function updateUserStats(users) {
        const totalUsers = users.length;
        const teacherCount = users.filter((u) => u.role === "teacher").length;
        const studentCount = users.filter((u) => u.role === "student").length;

        document.getElementById("totalUsers").textContent = totalUsers;
        document.getElementById("teacherCount").textContent = teacherCount;
        document.getElementById("studentCount").textContent = studentCount;
      }

      // === æ–°å¢ç”¨æˆ¶ ===
      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          const role = document.getElementById("role").value;

          if (!username || !password) {
            showNotification("âš ï¸ è«‹è¼¸å…¥å¸³è™ŸåŠå¯†ç¢¼", "warning");
            return;
          }

          showLoading("æ–°å¢ç”¨æˆ¶ä¸­...");
          try {
            const res = await fetch(`${apiUrl}/users`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username,
                password,
                role,
              }),
            });
            const result = await res.json();

            if (result.success) {
              showNotification("ç”¨æˆ¶æ–°å¢æˆåŠŸ", "success");
              e.target.reset();
              loadUsers();
            } else {
              showNotification("æ–°å¢å¤±æ•—: " + result.message, "error");
            }
          } catch (error) {
            console.error("æ–°å¢ç”¨æˆ¶æ™‚å‡ºéŒ¯:", error);
            showNotification("æ–°å¢ç”¨æˆ¶å¤±æ•—", "error");
          } finally {
            hideLoading();
          }
        });

      // === åˆªé™¤ç”¨æˆ¶ ===
      async function deleteUser(id) {
        showConfirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶ï¼Ÿ", async () => {
          showLoading("åˆªé™¤ç”¨æˆ¶ä¸­...");
          try {
            const res = await fetch(`${apiUrl}/users/${id}`, {
              method: "DELETE",
            });
            const result = await res.json();

            if (result.success) {
              showNotification("ç”¨æˆ¶åˆªé™¤æˆåŠŸ", "success");
              loadUsers();
            } else {
              showNotification("åˆªé™¤å¤±æ•—: " + result.message, "error");
            }
          } catch (error) {
            console.error("åˆªé™¤ç”¨æˆ¶æ™‚å‡ºéŒ¯:", error);
            showNotification("åˆªé™¤ç”¨æˆ¶å¤±æ•—", "error");
          } finally {
            hideLoading();
          }
        });
      }

      // === æ‰“é–‹ç·¨è¼¯è¦–çª— ===
      function openEditModal(id, username, role) {
        document.getElementById("editModal").classList.remove("hidden");
        document.getElementById("editUserId").value = id;
        document.getElementById("editUsername").value = username;
        document.getElementById("editRole").value = role;
        document.getElementById("editPassword").value = "";
      }

      // === é—œé–‰ç·¨è¼¯è¦–çª— ===
      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editModal").classList.add("hidden");
      });

      // === å„²å­˜ä¿®æ”¹ ===
      document
        .getElementById("saveEdit")
        .addEventListener("click", async () => {
          const id = document.getElementById("editUserId").value;
          const username = document.getElementById("editUsername").value.trim();
          const password = document.getElementById("editPassword").value.trim();
          const role = document.getElementById("editRole").value;

          if (!username) {
            showNotification("âš ï¸ å¸³è™Ÿä¸å¯ç©ºç™½", "warning");
            return;
          }

          showLoading("æ›´æ–°ç”¨æˆ¶ä¸­...");
          try {
            const res = await fetch(`${apiUrl}/users/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username,
                password: password || undefined,
                role,
              }),
            });
            const result = await res.json();

            if (result.success) {
              showNotification("ç”¨æˆ¶æ›´æ–°æˆåŠŸ", "success");
              document.getElementById("editModal").classList.add("hidden");
              loadUsers();
            } else {
              showNotification("æ›´æ–°å¤±æ•—: " + result.message, "error");
            }
          } catch (error) {
            console.error("æ›´æ–°ç”¨æˆ¶æ™‚å‡ºéŒ¯:", error);
            showNotification("æ›´æ–°ç”¨æˆ¶å¤±æ•—", "error");
          } finally {
            hideLoading();
          }
        });

      // æŸ¥çœ‹èª²ç¨‹è©³æƒ…
      async function viewCourseDetails(courseId) {
        showLoading("è¼‰å…¥èª²ç¨‹è©³æƒ…ä¸­...");
        try {
          const res = await fetch(`${apiUrl}/admin/courses/${courseId}`);
          const result = await res.json();

          if (result.success) {
            showCourseDetailModal(result.course);
          } else {
            showNotification("è¼‰å…¥èª²ç¨‹è©³æƒ…å¤±æ•—: " + result.message, "error");
          }
        } catch (error) {
          console.error("è¼‰å…¥èª²ç¨‹è©³æƒ…æ™‚å‡ºéŒ¯:", error);
          showNotification("è¼‰å…¥èª²ç¨‹è©³æƒ…å¤±æ•—", "error");
        } finally {
          hideLoading();
        }
      }

      // é¡¯ç¤ºèª²ç¨‹è©³æƒ…æ¨¡æ…‹æ¡†
      function showCourseDetailModal(course) {
        // å‰µå»ºæ¨¡æ…‹æ¡†
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50";
        modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-semibold mb-4 text-blue-700 flex items-center">
        <span class="mr-2">ğŸ“š</span> èª²ç¨‹è©³æƒ… - ${course.name}
      </h3>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="font-semibold text-gray-700">èª²ç¨‹ID</label>
            <p class="mt-1">${course.id}</p>
          </div>
          <div>
            <label class="font-semibold text-gray-700">èª²ç¨‹åç¨±</label>
            <p class="mt-1">${course.name}</p>
          </div>
        </div>
        
        <div>
          <label class="font-semibold text-gray-700">èª²ç¨‹æè¿°</label>
          <p class="mt-1 p-2 bg-gray-50 rounded">${
            course.description || "ç„¡æè¿°"
          }</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="font-semibold text-gray-700">æˆèª²æ•™å¸«</label>
            <p class="mt-1">${course.teacher_name} (ID: ${
          course.teacher_id
        })</p>
          </div>
          <div>
            <label class="font-semibold text-gray-700">å‰µå»ºæ™‚é–“</label>
            <p class="mt-1">${new Date(course.created_at).toLocaleString()}</p>
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center p-3 bg-blue-50 rounded">
            <div class="text-2xl font-bold text-blue-700">${
              course.student_count
            }</div>
            <div class="text-sm text-blue-600">å­¸ç”Ÿäººæ•¸</div>
          </div>
          <div class="text-center p-3 bg-green-50 rounded">
            <div class="text-2xl font-bold text-green-700">${
              course.material_count
            }</div>
            <div class="text-sm text-green-600">æ•™ææ•¸é‡</div>
          </div>
          <div class="text-center p-3 bg-purple-50 rounded">
            <div class="text-2xl font-bold text-purple-700">${
              course.homework_count
            }</div>
            <div class="text-sm text-purple-600">ä½œæ¥­æ•¸é‡</div>
          </div>
        </div>
        
        <div>
          <label class="font-semibold text-gray-700">é¸èª²å­¸ç”Ÿ</label>
          <div class="mt-1 max-h-32 overflow-y-auto">
            ${
              course.students && course.students.length > 0
                ? course.students
                    .map(
                      (s) =>
                        `<span class="inline-block bg-gray-100 px-2 py-1 rounded text-sm mr-2 mb-2">${s.username} (ID: ${s.id})</span>`
                    )
                    .join("")
                : '<p class="text-gray-500">æš«ç„¡å­¸ç”Ÿé¸èª²</p>'
            }
          </div>
        </div>
      </div>
      
      <div class="mt-6 flex justify-end">
        <button onclick="this.closest('.fixed').remove()" 
                class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 smooth-transition">
          é—œé–‰
        </button>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // åˆªé™¤èª²ç¨‹
      async function deleteCourse(courseId) {
        showConfirm("ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ", async () => {
          showLoading("åˆªé™¤èª²ç¨‹ä¸­...");
          try {
            // é€™è£¡éœ€è¦å¯¦ç¾åˆªé™¤èª²ç¨‹çš„API
            showNotification("èª²ç¨‹åˆªé™¤åŠŸèƒ½å¾…å¯¦ç¾", "warning");
          } catch (error) {
            console.error("åˆªé™¤èª²ç¨‹æ™‚å‡ºéŒ¯:", error);
            showNotification("åˆªé™¤èª²ç¨‹å¤±æ•—", "error");
          } finally {
            hideLoading();
          }
        });
      }

      // === ç³»çµ±ç›£æ¸¬åŠŸèƒ½ ===
      async function loadSystemStatus() {
        try {
          // æ¨¡æ“¬ç³»çµ±ç‹€æ…‹æ•¸æ“š
          const systemData = {
            serverStatus: "é‹è¡Œä¸­",
            databaseStatus: "å·²é€£æ¥",
            uptime: 86400 + 3600 + 300, // 1å¤©1å°æ™‚5åˆ†é˜
            memoryUsage: {
              heapUsed: 150 * 1024 * 1024, // 150MB
            },
            userCount: document.getElementById("totalUsers").textContent || 0,
            courseCount:
              document.getElementById("totalCourses").textContent || 0,
          };

          // æ›´æ–°é‹è¡Œæ™‚é–“
          const uptimeDays = Math.floor(systemData.uptime / 86400);
          const uptimeHours = Math.floor((systemData.uptime % 86400) / 3600);
          const uptimeMinutes = Math.floor((systemData.uptime % 3600) / 60);
          document.getElementById(
            "uptime"
          ).textContent = `${uptimeDays} å¤© ${uptimeHours} æ™‚ ${uptimeMinutes} åˆ†`;

          // æ›´æ–°è¨˜æ†¶é«”ä½¿ç”¨
          const memoryMB = Math.round(
            systemData.memoryUsage.heapUsed / 1024 / 1024
          );
          const memoryPercent = Math.min(
            100,
            Math.round((memoryMB / 512) * 100)
          ); // å‡è¨­æœ€å¤§ 512MB
          document.getElementById("memoryUsage").textContent = `${memoryMB} MB`;
          document.getElementById(
            "memoryBar"
          ).style.width = `${memoryPercent}%`;

          // æ›´æ–°CPUä½¿ç”¨ç‡ï¼ˆæ¨¡æ“¬æ•¸æ“šï¼‰
          const cpuPercent = Math.floor(Math.random() * 30) + 10; // 10-40%
          document.getElementById("cpuUsage").textContent = `${cpuPercent}%`;
          document.getElementById("cpuBar").style.width = `${cpuPercent}%`;

          // æ›´æ–°å…¶ä»–è³‡è¨Š
          document.getElementById("onlineUsers").textContent =
            systemData.userCount;
          document.getElementById("activeCoursesCount").textContent =
            systemData.courseCount;
          document.getElementById("todayMessages").textContent = Math.floor(
            Math.random() * 50
          );

          showNotification("ç³»çµ±ç‹€æ…‹å·²æ›´æ–°", "success");
        } catch (error) {
          console.error("è¼‰å…¥ç³»çµ±ç‹€æ…‹æ™‚å‡ºéŒ¯:", error);
        }
      }

      // å®šæœŸæ›´æ–°ç³»çµ±ç‹€æ…‹
      setInterval(() => {
        if (
          !document
            .getElementById("system-monitoring")
            .classList.contains("hidden")
        ) {
          loadSystemStatus();
        }
      }, 10000);

      // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ¬Šé™
      window.addEventListener("load", function () {
        fetch("/check-auth", {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache, no-store, must-revalidate",
            Pragma: "no-cache",
            Expires: "0",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success || data.user.role !== "admin") {
              // æœªç™»å…¥æˆ–éç®¡ç†å“¡ï¼Œç«‹å³é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
              document.body.innerHTML = `
              <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
                <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                  <h1 style="color: #ef4444; margin-bottom: 1rem;">âš ï¸ æœªæˆæ¬Šè¨ªå•</h1>
                  <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">${JSON.stringify(
                    data.success
                      ? { success: false, message: "éœ€è¦ç®¡ç†å“¡æ¬Šé™" }
                      : data,
                    null,
                    2
                  )}</pre>
                  <p style="margin-top: 1rem; color: #6b7280;">
                    <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                  </p>
                </div>
              </div>
            `;
              return;
            }
            // æ¬Šé™é©—è­‰é€šéï¼Œåˆå§‹åŒ–ç®¡ç†å“¡é é¢
            initAdminPage();
          })
          .catch((error) => {
            console.error("èªè­‰æª¢æŸ¥éŒ¯èª¤:", error);
            document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f3f4f6;">
              <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                <h1 style="color: #ef4444; margin-bottom: 1rem;">âŒ é€£æ¥éŒ¯èª¤</h1>
                <pre style="background: #f9fafb; padding: 1rem; border-radius: 4px; border: 1px solid #e5e7eb;">{"success": false, "message": "è«‹å…ˆç™»å…¥ç³»çµ±"}</pre>
                <p style="margin-top: 1rem; color: #6b7280;">
                  <a href="/login.html" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé€™è£¡é‡æ–°ç™»å…¥</a>
                </p>
              </div>
            </div>
          `;
          });
      });

      // é˜²æ­¢ä½¿ç”¨ç€è¦½å™¨è¿”å›æŒ‰éˆ•
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      });

      // åˆå§‹åŒ–ç®¡ç†å“¡é é¢çš„å‡½æ•¸
      function initAdminPage() {
        console.log("ğŸ”§ åˆå§‹åŒ–ç®¡ç†å“¡å°ˆå€");

        // è¨­ç½®å´é‚Šæ¬„é»æ“Šäº‹ä»¶
        document.querySelectorAll(".sidebar-item").forEach((item) => {
          item.addEventListener("click", function () {
            // ç§»é™¤æ‰€æœ‰activeé¡
            document
              .querySelectorAll(".sidebar-item")
              .forEach((i) => i.classList.remove("active"));
            // æ·»åŠ activeé¡åˆ°ç•¶å‰é»æ“Šçš„é …ç›®
            this.classList.add("active");

            // æ ¹æ“šé»æ“Šçš„é …ç›®è¼‰å…¥å°æ‡‰æ•¸æ“š
            const sectionId =
              this.getAttribute("onclick").match(/'([^']+)'/)[1];
            if (sectionId === "course-management") {
              setTimeout(() => {
                loadCourses();
              }, 100);
            } else if (sectionId === "system-monitoring") {
              setTimeout(() => {
                loadSystemStatus();
              }, 100);
            }
          });
        });

        // é¡¯ç¤ºç”¨æˆ¶ç®¡ç†å€å¡Šä¸¦è¼‰å…¥ç”¨æˆ¶
        showSection("user-management");

        // åˆå§‹åŒ–æœå°‹åŠŸèƒ½
        initSearch();

        // ç«‹å³è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
        setTimeout(() => {
          loadUsers();
        }, 100);
      }

      // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ– (ç¾åœ¨åªæ˜¯ä¿ç•™ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ)
      document.addEventListener("DOMContentLoaded", () => {
        // æ‰€æœ‰åˆå§‹åŒ–å·²ç§»è‡³ load äº‹ä»¶çš„æ¬Šé™æª¢æŸ¥å¾ŒåŸ·è¡Œ
        console.log("ğŸ“„ DOM å…§å®¹å·²è¼‰å…¥ï¼Œç­‰å¾…æ¬Šé™é©—è­‰...");
      });
    </script>
  </body>
</html>
